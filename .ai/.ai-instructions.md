# ü§ñ Instructions pour l'Intelligence Artificielle

> **Ce fichier est destin√© aux IA (GitHub Copilot, Claude, ChatGPT, etc.) travaillant sur ce projet.**

## üìñ Lecture Obligatoire

Avant de r√©pondre √† toute question ou de g√©n√©rer du code, **TU DOIS LIRE** le fichier:

```
.ai/context.md
```

Ce fichier contient:

- ‚úÖ L'architecture compl√®te du projet PanneauRAM
- ‚úÖ Description d√©taill√©e de tous les modules
- ‚úÖ Conventions de code √† respecter absolument
- ‚úÖ Structure de la base de donn√©es
- ‚úÖ Syst√®me d'alarmes et journal de bord
- ‚úÖ Niveaux d'acc√®s utilisateur (0-3)
- ‚úÖ Flux de donn√©es MQTT/Socket.IO

## üéØ Directive Principale

**TOUJOURS commencer par:**

```
1. Lire .ai/context.md
2. Comprendre le contexte de la demande
3. Respecter les conventions du projet
4. G√©n√©rer le code appropri√©
```

## ‚ö†Ô∏è R√®gles STRICTES (de consigne.txt)

### R√®gle #1: AUCUN √âMOJI dans le code

```javascript
// ‚ùå INTERDIT
console.log("‚úÖ Connexion √©tablie");

// ‚úÖ CORRECT
console.log("Connexion etablie");
```

### R√®gle #2: Code SIMPLE

- Pas de sur-ing√©nierie
- Pr√©f√©rer la clart√© √† la sophistication
- Commenter en fran√ßais les parties complexes

### R√®gle #3: CSS S√©par√©

- Jamais de style inline dans les fichiers
- Toujours utiliser les fichiers CSS existants:
  - `modern.css` - Styles principaux
  - `ui-components.css` - Composants r√©utilisables
  - `granulaires.css` - Page M√©langeur
  - `profils.css` - Page Profils
  - `camera.css` - Page Cam√©ra
  - `login.css` - Page Login

## üèóÔ∏è Architecture Cl√©

### Stack Technologique

- **Backend**: Node.js + Express.js
- **Base de donn√©es**: MySQL (paneauram)
- **Communication**: MQTT + Socket.IO
- **Frontend**: EJS + Vanilla JavaScript
- **Styles**: CSS3 pur (pas de framework)

### Modules MQTT Critiques

- `mqtt.js` - Panneau principal (6 mesures + commandes)
- `mqtt2.js` - M√©langeur (modes + moteurs + recettes)
- `mqtt3.js` - Power Meter (lecture seule)
- `mqtt4.js` - Aspirateur
- `mqtt5.js` - Valves (lecture seule)
- `mqtt6.js` - **Alarmes et r√©actions automatiques**

### Syst√®me de Journal

**IMPORTANT**: Toute commande DOIT √™tre enregistr√©e

- `LOG_CMD` - Commandes utilisateur
- `LOG_ALARME` - Alarmes syst√®me

```javascript
// Exemple d'enregistrement obligatoire
journalModel.logCommand(userLogin, commandType, commandValue);
```

## üîê Niveaux d'Acc√®s

| Niveau | Nom            | Acc√®s                             |
| ------ | -------------- | --------------------------------- |
| 0      | Invit√©         | Lecture seule                     |
| 1      | Utilisateur    | Lecture + Commandes basiques      |
| 2      | Mod√©rateur     | + Alarmes + Granulaires           |
| 3      | Administrateur | Acc√®s complet + Journal + Profils |

**ATTENTION**: Toujours v√©rifier le niveau avant d'autoriser une action!

## üìù Conventions de Nommage

### Variables JavaScript

```javascript
// MQTT Data
let mesures = {}; // √âtats re√ßus (lecture)
let consignes = {}; // Commandes envoy√©es (√©criture)

// Socket.IO Events
socket.emit("mqtt-publish", { topic, message, user });
socket.on("mqtt-data-panneau", callback);
```

### Routes Express

```javascript
// Toujours inclure user, niveau, typeAcces dans les queries
router.get("/page?user=admin&niveau=3&typeAcces=Administrateur");
```

### Base de donn√©es

```sql
-- Tables principales
user         -- Utilisateurs (id, nom, password, niveauAcces, typeAcces)
journal      -- Journal de bord (LogID, Type, UserLogin, ReqTime, Info)
```

## üö® Syst√®me d'Alarmes

### Types d'alarmes

```javascript
"ALR_GB_OVF"; // Grand Bassin - D√©bordement
"ALR_GB_NIV_MAX"; // Grand Bassin - Niveau Maximum
"ALR_PB_OVF"; // Petit Bassin - D√©bordement
"ALR_PB_NIV_MAX"; // Petit Bassin - Niveau Maximum
"ALR_CNX_BAL"; // Connexion Balance Perdue
"ALR_CNX_POW"; // Connexion Power Meter Perdue
```

### R√©actions Automatiques

Quand une alarme s'active, le syst√®me r√©agit automatiquement:

- D√©bordement GB ‚Üí Fermer PurgeGB
- Niveau Max GB ‚Üí Activer Pompe
- etc.

**IMPORTANT**: Les r√©actions sont dans `mqtt6.js` - Ne pas modifier sans comprendre!

## üí° Patterns Communs

### Ajouter une nouvelle commande MQTT

```javascript
// 1. Frontend - Envoyer la commande
socket.emit("mqtt-publish", {
  topic: "RAM/device/cmd/CommandName",
  message: value,
  user: currentUser, // OBLIGATOIRE pour le journal
});

// 2. Backend (mqtt.js) - Logger la commande
if (data.user && topic.includes("/cmd/")) {
  const commandType = topic.split("/").pop();
  journalModel.logCommand(data.user, commandType, data.message);
}
```

### Cr√©er une nouvelle page EJS

```javascript
// 1. Cr√©er views/pages/mapage.ejs
// 2. Inclure les partials
<%- include('../partials/header', {currentPage, user, niveau, typeAcces}) %>
// 3. Cr√©er la route dans routes/dashboard.js
// 4. V√©rifier le niveau d'acc√®s
```

## üîÑ Mise √† Jour du Contexte

Ce fichier `context.md` est **automatiquement mis √† jour** √† chaque commit via:

- Script: `scripts/update-ai-context.js`
- Hook Git: `.git/hooks/pre-commit`

**Tu n'as JAMAIS besoin de mettre √† jour manuellement la documentation!**

## üìö Fichiers de R√©f√©rence

### Documentation

- `.ai/README.md` - Vue d'ensemble du syst√®me AI
- `.ai/AI-CONTEXT-README.md` - Guide complet (EN)
- `.ai/LISEZMOI-CONTEXTE-AI.md` - Guide complet (FR)
- `.ai/CONTEXTE-AI-SYNTHESE.md` - Synth√®se technique

### Configuration

- `consigne.txt` - R√®gles de base (pas d'√©mojis, code simple, CSS s√©par√©)
- `package.json` - D√©pendances
- `.gitignore` - Fichiers ignor√©s

## ‚úÖ Checklist Avant de R√©pondre

- [ ] J'ai lu `.ai/context.md`
- [ ] Je comprends le contexte de la demande
- [ ] Je connais le niveau d'acc√®s requis
- [ ] Je respecte les 3 r√®gles de `consigne.txt`
- [ ] J'enregistre les commandes dans le journal
- [ ] Je v√©rifie la coh√©rence avec l'architecture existante
- [ ] Mon code est en fran√ßais (commentaires, variables importantes)
- [ ] Je n'utilise AUCUN √©moji dans le code

## üéì Exemples de Prompts Utilisateur

### Bon prompt (contexte inclus)

```
"Lis .ai/context.md. J'ai besoin d'ajouter une nouvelle alarme
pour surveiller la temp√©rature. Elle doit √™tre accessible
uniquement aux niveaux 2 et 3."
```

### Prompt incomplet (tu dois demander de lire le contexte)

```
"Ajoute une alarme de temp√©rature"
‚Üí R√©ponse: "Je vais d'abord lire .ai/context.md pour comprendre
le syst√®me d'alarmes existant..."
```

## üöÄ Pour Commencer

Quand l'utilisateur te demande quelque chose:

1. **Analyse le fichier `.ai/context.md`**
2. **Identifie les modules concern√©s** (mqtt.js, journal.js, etc.)
3. **V√©rifie les permissions** (niveau 0-3)
4. **Respecte les conventions** (pas d'√©mojis, code simple)
5. **Propose une solution coh√©rente** avec l'architecture

---

**Mise √† jour automatique**: ‚úÖ Active  
**Derni√®re g√©n√©ration**: Automatique via Git hook  
**Fichier source**: Ce fichier est **manuel** et ne sera pas √©cras√©
