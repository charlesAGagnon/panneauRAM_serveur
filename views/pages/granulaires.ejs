<!--
* @file granulaires.ejs
* @author charles-Antoine Gagnon
* @version 4 - Simplifié avec jQuery et partials
* @date 11/11/2025
* @brief Granudoseur Control - Mélangeur & Aspirateur
-->
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PanneauRAM - Granudoseur</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/stylesheets/modern.css">
    <link rel="stylesheet" href="/stylesheets/ui-components.css">
    <link rel="stylesheet" href="/stylesheets/granulaires.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body style="margin: 0; padding: 0; background: #f8f9fa;">

    <%- include('../partials/header', { currentPage: 'granulaires', user, niveau, typeAcces }) %>

    <!-- MAIN CONTENT: 2 COLUMNS -->
    <div class="granulaires-grid">

        <!-- COLUMN 1: MELANGEUR -->
        <div class="section-column">

            <!-- État Mélangeur -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-header-title"> État Mélangeur</h2>
                </div>
                <div class="card-body">
                    <div class="status-display">
                        <span class="status-label">Recette Actuelle :</span>
                        <span id="recette-status" class="status-value" style="color: #0d6efd;">Aucune</span>
                    </div>
                </div>
            </div>

            <!-- Mode Contrôle -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-header-title"> Mode</h2>
                </div>
                <div class="card-body">
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <div class="status-display">
                            <span class="status-label">Mode actuel :</span>
                            <span class="status-value" id="mode-melangeur">-</span>
                        </div>
                        <% if (niveau !== '0') { %>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn-mode-control btn btn-primary" data-mode="auto" style="flex: 1;">
                                Auto
                            </button>
                            <button class="btn-mode-control btn btn-primary" data-mode="manuel" style="flex: 1;">
                                Manuel
                            </button>
                        </div>
                        <% } %>
                    </div>
                </div>
            </div>

            <!-- Moteurs -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-header-title"> Moteurs</h2>
                </div>
                <div class="card-body" style="display: flex; flex-direction: column; gap: 16px;">
                    <!-- Commandes -->
                    <div class="motors-section">
                        <p class="section-title"> COMMANDES (Envoyer l'ordre)</p>
                        <div class="motors-buttons">
                            <% ['A', 'B', 'C'].forEach(motor => { %>
                            <button id="btn-mot<%= motor %>" class="btn btn-primary motor-btn" data-motor="<%= motor.toLowerCase() %>" <% if (niveau === '0') { %>disabled<% } %>>
                                Moteur <%= motor %> - OFF
                            </button>
                            <% }); %>
                        </div>
                    </div>

                    <!-- États MQTT -->
                    <div>
                        <p class="section-title"> ÉTATS (Reçus du système)</p>
                        <div class="motors-status-grid">
                            <% ['A', 'B', 'C'].forEach(motor => { %>
                            <div class="motor-status-card">
                                <p class="motor-status-label">Moteur <%= motor %></p>
                                <span class="motor-status-badge off" id="status-mot<%= motor %>">OFF</span>
                            </div>
                            <% }); %>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recette -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-header-title"> Recette Personnalisée</h2>
                </div>
                <div class="card-body">
                    <form id="recipe-form" class="recipe-form">
                        <% for(let i = 1; i <= 3; i++) { %>
                        <div class="form-group">
                            <label class="form-label">Ingrédient <%= i %></label>
                            <input type="number" class="form-control" id="ing<%= i %>" placeholder="0" min="0" max="100" <% if (niveau === '0') { %>disabled<% } %>>
                        </div>
                        <% } %>
                        <button type="submit" class="btn btn-success" <% if (niveau === '0') { %>disabled<% } %>> Valider Recette</button>
                    </form>
                </div>
            </div>

        </div>

        <!-- COLUMN 2: ASPIRATEUR -->
        <div class="section-column">

            <!-- État Aspirateur -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-header-title"> État Aspirateur</h2>
                </div>
                <div class="card-body">
                    <div class="status-display">
                        <span class="status-label">Sequence :</span>
                        <span id="aspirateur-status" class="status-value" style="color: #198754;">OFF</span>
                    </div>
                </div>
            </div>

            <!-- Balance (Pi 1) -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-header-title"> Balance</h2>
                </div>
                <div class="card-body" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                    <div class="stat-card">
                        <div class="stat-label">Poids</div>
                        <div class="stat-value" id="etat-poids" style="font-size: 20px;">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Tare</div>
                        <div class="stat-value" id="etat-tare" style="font-size: 20px;">--</div>
                    </div>
                    <div class="stat-card" style="grid-column: 1 / -1;">
                        <div class="stat-label">Unité</div>
                        <div class="stat-value" id="etat-unite" style="font-size: 18px; color: #6b7280;">--</div>
                    </div>
                </div>
            </div>

            <!-- Niveaux Cylindres -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-header-title"> Niveaux Cylindres</h2>
                </div>
                <div class="card-body">
                    <% ['A', 'B', 'C'].forEach(cyl => { %>
                    <div class="cylinder-item">
                        <div class="cylinder-label">Cylindre <%= cyl %></div>
                        <div class="cylinder-progress-container">
                            <div class="cylinder-progress-bar">
                                <div id="progress-cyl-<%= cyl.toLowerCase() %>" class="cylinder-progress-fill" style="width: 0%;"></div>
                            </div>
                            <span class="cylinder-value" id="val-cyl-<%= cyl.toLowerCase() %>">0%</span>
                        </div>
                    </div>
                    <% }); %>
                </div>
            </div>

            <!-- Commandes -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-header-title"> Commandes</h2>
                </div>
                <div class="card-body">
                    <button id="btn-force" class="btn btn-danger" style="width: 100%;" <% if (niveau === '0') { %>disabled<% } %>>
                        Force
                    </button>
                </div>
            </div>

        </div>

    </div>

    <!-- FOOTER -->
    <footer style="background: white; border-top: 1px solid #e5e7eb; padding: 16px 24px; text-align: center; margin-top: 24px; color: #6b7280; font-size: 12px;">
        <%- include('../partials/footer') %>
    </footer>

    <script>
        const socket = io();
        const niveau = '<%= niveau %>';
        const canWrite = niveau !== '0';

        // État local des moteurs (ce qu'on a envoyé)
        const localMotorState = {
            motA: 'off',
            motB: 'off',
            motC: 'off'
        };

        // Données MQTT
        const mqttData = {
            melangeur:
            {
                motA: 'off',
                motB: 'off',
                motC: 'off',
                recetteStatut: 'AUCUNE',
                mode: 'auto'
            },
            aspirateur:
            {
                sequence: 'off',
                NivA: 0,
                NivB: 0,
                NivC: 0
            }
        };

        // ===== SOCKET.IO EVENTS =====
        socket.on('connect', () =>
        {
            console.log('Connecte');
            socket.emit('join-pi1');
            socket.emit('join-pi2');
            socket.emit('join-pi4');
        });

        socket.on('disconnect', () => console.log('Deconnecte'));

        // ALARMES - Notifications pour niveaux 2 et 3
        socket.on('mqtt-data-alarmes', (data) =>
        {
            const niveau = '<%= niveau %>';
            if ((niveau === '2' || niveau === '3') && data.value && (data.value === 'ON' || data.value === '1' || data.value === 1))
            {
                showAlarmNotification(data.key);
            }
        });

        function showAlarmNotification(alarmKey)
        {
            const alarmLabels = {
                'ALR_GB_OVF': 'Grand Bassin - Débordement',
                'ALR_GB_NIV_MAX': 'Grand Bassin - Niveau Maximum',
                'ALR_PB_OVF': 'Petit Bassin - Débordement',
                'ALR_PB_NIV_MAX': 'Petit Bassin - Niveau Maximum',
                'ALR_CNX_BAL': 'Connexion Balance Perdue',
                'ALR_CNX_POW': 'Connexion Power Meter Perdue'
            };
            const label = alarmLabels[alarmKey] || alarmKey;
            const reqTime = new Date().toISOString();
            const notification = $('<div>')
                .addClass('alarm-notification')
                .attr('data-alarm-key', alarmKey)
                .attr('data-req-time', reqTime)
                .html(`
                    <div style="background: #dc2626; color: white; padding: 16px; border-radius: 8px; margin: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 24px;">!</span>
                            <div style="flex: 1;">
                                <strong style="font-size: 16px;">ALARME DÉCLENCHÉE</strong>
                                <div style="font-size: 14px; margin-top: 4px;">${label}</div>
                                <div style="font-size: 12px; margin-top: 4px; opacity: 0.9;">Le système va tenter de corriger automatiquement</div>
                            </div>
                            <button onclick="acknowledgeAlarmGranulaires('${alarmKey}')" style="background: #f59e0b; border: none; color: white; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 600;">ACK</button>
                        </div>
                    </div>
                `);

            let container = $('#alarm-notifications');
            if (container.length === 0)
            {
                container = $('<div>')
                    .attr('id', 'alarm-notifications')
                    .css(
                    {
                        position: 'fixed',
                        top: '80px',
                        right: '20px',
                        zIndex: 1000,
                        maxWidth: '400px'
                    });
                $('body').append(container);
            }

            container.append(notification);

            setTimeout(() =>
            {
                notification.remove();
            }, 10000);
        }

        window.acknowledgeAlarmGranulaires = function(alarmKey)
        {
            const notifications = $(`.alarm-notification[data-alarm-key="${alarmKey}"]`);
            if (notifications.length === 0) return;

            notifications.each(function()
            {
                const reqTime = $(this).attr('data-req-time');
                const currentUser = '<%= user %>';

                socket.emit('mqtt-acknowledge-alarm',
                {
                    alarmType: alarmKey,
                    user: currentUser,
                    reqTime: reqTime
                });

                $(this).remove();
            });

            console.log(`Alarme ${alarmKey} reconnue par <%= user %>`);
        };

        // MELANGEUR (Pi 2)
        socket.on('mqtt-initial-data-pi2', (data) =>
        {
            $.extend(mqttData.melangeur, data);
            updateMelangeur();
        });

        // MELANGEUR - Recevoir les dernières commandes envoyées
        socket.on('mqtt-initial-commands-pi2', (data) =>
        {
            console.log('Pi2 - Dernières consignes reçues:', data);
            // Restaurer l'état local des moteurs
            if (data.motA) localMotorState.motA = data.motA;
            if (data.motB) localMotorState.motB = data.motB;
            if (data.motC) localMotorState.motC = data.motC;

            // Restaurer le mode
            if (data.mode) mqttData.melangeur.mode = data.mode;

            // Restaurer les inputs de recette
            if (data.recette) $('#input-recette').val(data.recette);

            updateMelangeur();
        });

        socket.on('mqtt-data-pi2', (msg) =>
        {
            if (msg.key)
            {
                mqttData.melangeur[msg.key] = msg.value;
                updateMelangeur();
            }
        });

        // BALANCE (Pi 1)
        socket.on('mqtt-initial-data-pi1', (data) =>
        {
            console.log('Balance - Donnees initiales:', data);
            updateBalance(data);
        });

        socket.on('mqtt-data-pi1', (msg) =>
        {
            console.log('Balance - Mise a jour:', msg);
            if (msg.key && msg.value !== undefined)
            {
                const balanceData = {};
                balanceData[msg.key] = msg.value;
                updateBalance(balanceData);
            }
        });

        // ASPIRATEUR (Pi 4)
        socket.on('mqtt-initial-data-pi4', (data) =>
        {
            $.extend(mqttData.aspirateur, data);
            updateAspirateur();
        });

        socket.on('mqtt-data-pi4', (msg) =>
        {
            if (msg.key)
            {
                mqttData.aspirateur[msg.key] = msg.value;
                updateAspirateur();
            }
        });

        // ===== UPDATE FUNCTIONS =====
        function updateMelangeur()
        {
            // Mise à jour des boutons (état local)
            ['A', 'B', 'C'].forEach(m =>
            {
                const key = `mot${m}`;
                const btn = $(`#btn-mot${m}`);
                const state = localMotorState[key];
                btn.text(`Moteur ${m} - ${state.toUpperCase()}`)
                    .removeClass('btn-motor-off btn-motor-on')
                    .addClass(state === 'on' ? 'btn-motor-on' : 'btn-motor-off');
            });

            // Mise à jour des badges (état MQTT)
            ['A', 'B', 'C'].forEach(m =>
            {
                const key = `mot${m}`;
                const badge = $(`#status-mot${m}`);
                const state = mqttData.melangeur[key] || 'off';
                badge.text(state.toUpperCase())
                    .removeClass('on off')
                    .addClass(state === 'on' ? 'on' : 'off');
            });

            // Recette status
            const status = mqttData.melangeur.recetteStatut || 'Aucune';
            $('#recette-status')
                .text(status)
                .css('color', status === 'AUCUNE' ? '#0d6efd' :
                    status.includes('FINISH') ? '#198754' : '#ffc107');

            // Mode status
            const mode = mqttData.melangeur.mode || 'auto';
            $('#mode-melangeur').text(mode.toUpperCase());

            // Mettre à jour les boutons de mode (style actif)
            $('.btn-mode-control').each(function()
            {
                const btnMode = $(this).data('mode');
                if (btnMode === mode)
                {
                    $(this).css(
                    {
                        'background': '#3b82f6',
                        'color': 'white'
                    });
                }
                else
                {
                    $(this).css(
                    {
                        'background': 'white',
                        'color': '#3b82f6'
                    });
                }
            });
        }

        function updateBalance(data)
        {
            if (data.poids !== undefined)
            {
                const poids = parseFloat(data.poids) || 0;
                $('#etat-poids').text(poids.toFixed(2));
            }
            if (data.tare !== undefined)
            {
                const tare = parseFloat(data.tare) || 0;
                $('#etat-tare').text(tare.toFixed(2));
            }
            if (data.unite !== undefined)
            {
                $('#etat-unite').text(data.unite.toUpperCase());
            }
        }

        function updateAspirateur()
        {
            // Sequence
            const seq = (mqttData.aspirateur.sequence || 'OFF').toUpperCase();
            $('#aspirateur-status')
                .text(seq)
                .css('color', seq === 'OFF' ? '#ef4444' : '#198754');

            // Cylindres
            ['A', 'B', 'C'].forEach(c =>
            {
                const key = `Niv${c}`;
                const val = mqttData.aspirateur[key] || 0;
                $(`#val-cyl-${c.toLowerCase()}`).text(val + '%');
                $(`#progress-cyl-${c.toLowerCase()}`).css('width', val + '%');
            });
        }

        // ===== EVENT HANDLERS =====
        // Moteurs
        $('.motor-btn').click(function()
        {
            if (!canWrite) return;

            const motor = $(this).data('motor'); // 'a', 'b', 'c'
            const key = `mot${motor.toUpperCase()}`;
            const currentState = localMotorState[key];
            const newState = currentState === 'off' ? 'on' : 'off';

            localMotorState[key] = newState;
            updateMelangeur();

            // FIX: Utiliser le bon événement socket
            socket.emit('mqtt-command-pi2-motor',
            {
                motor: key,
                value: newState
            });
        });

        // Force
        $('#btn-force').click(() =>
        {
            if (!canWrite) return;
            socket.emit('mqtt-command-pi4-force',
            {
                value: '1'
            });
        });

        // Recette
        $('#recipe-form').submit(function(e)
        {
            e.preventDefault();
            if (!canWrite) return;

            const recipe = [1, 2, 3].map(i => $(`#ing${i}`).val() || '0').join(',');
            socket.emit('mqtt-command-pi2-recette',
            {
                value: recipe,
                user: '<%= user %>'
            });

            // Clear form
            $(this).trigger('reset');
        });

        // Mode Control
        $('.btn-mode-control').click(function()
        {
            if (!canWrite) return;

            const mode = $(this).data('mode');
            console.log('Changement de mode vers:', mode);

            // Mettre à jour localement
            mqttData.melangeur.mode = mode;
            updateMelangeur();

            // Envoyer la commande
            socket.emit('mqtt-command-pi2-mode',
            {
                value: mode,
                user: '<%= user %>'
            });
        });

    </script>

</body>
</html>
