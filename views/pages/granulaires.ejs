<!--
* @file granulaires.ejs
* @author charles-Antoine Gagnon
* @version 3 - Modern responsive 2-column layout
* @date 11/11/2025
* @brief Granudoseur Control - M√©langeur & Aspirateur
-->
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PanneauRAM - Granudoseur</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/stylesheets/modern.css">
    <link rel="stylesheet" href="/stylesheets/ui-components.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body style="margin: 0; padding: 0; background: #f8f9fa;">

    <!-- NAVBAR -->
    <nav class="navbar-modern">
        <div class="navbar-modern-container">
            <a href="/home?user=<%= user %>&niveau=<%= niveau %>&typeAcces=<%= typeAcces %>" class="navbar-brand-modern">
                üéõÔ∏è PanneauRAM
            </a>
            <ul class="navbar-menu">
                <li class="navbar-menu-item">
                    <a href="/home?user=<%= user %>&niveau=<%= niveau %>&typeAcces=<%= typeAcces %>" class="navbar-menu-link">üè† Accueil</a>
                </li>
                <li class="navbar-menu-item">
                    <a href="/dashboard?user=<%= user %>&niveau=<%= niveau %>&typeAcces=<%= typeAcces %>" class="navbar-menu-link">üìä RAM</a>
                </li>
                <li class="navbar-menu-item">
                    <a href="/granulaires?user=<%= user %>&niveau=<%= niveau %>&typeAcces=<%= typeAcces %>" class="navbar-menu-link active">üåæ Granudoseur</a>
                </li>
                <li class="navbar-menu-item">
                    <a href="/journal?user=<%= user %>&niveau=<%= niveau %>&typeAcces=<%= typeAcces %>" class="navbar-menu-link">üìã Journal</a>
                </li>
                <li class="navbar-menu-item">
                    <a href="/alertes?user=<%= user %>&niveau=<%= niveau %>&typeAcces=<%= typeAcces %>" class="navbar-menu-link">üîî Alertes</a>
                </li>
                <% if (niveau !== '0') { %>
                <li class="navbar-menu-item">
                    <a href="/comptes?user=<%= user %>&niveau=<%= niveau %>&typeAcces=<%= typeAcces %>" class="navbar-menu-link">üë• Comptes</a>
                </li>
                <% } %>
            </ul>
            <div class="navbar-right">
                <div class="navbar-user">
                    <span id="connection-status" class="navbar-badge" style="background-color: #ef4444;">Hors ligne</span>
                    <span style="margin-left: 8px;">
                        <strong><%= user %></strong> ‚Ä¢ <%= typeAcces %> (L<%= niveau %>)
                        <% if (niveau === '0') { %>
                        <span style="display: inline-block; margin-left: 8px; background: #0dcaf0; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">üîí R/O</span>
                        <% } %>
                    </span>
                </div>
                <a href="/" class="navbar-logout">D√©connexion</a>
            </div>
        </div>
    </nav>

    <!-- MAIN CONTENT: 2 COLUMNS -->
    <div style="padding: 24px; display: grid; grid-template-columns: 1.5fr 1fr; gap: 24px;">

        <!-- COLUMN 1: MELANGEUR -->
        <div style="display: flex; flex-direction: column; gap: 16px;">

            <!-- STATE -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-header-title">üéõÔ∏è √âtat M√©langeur</h2>
                </div>
                <div class="card-body">
                    <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #f3f4f6; border-radius: 8px;">
                        <span style="font-size: 14px; font-weight: 500; color: #6b7280;">Recette Actuelle :</span>
                        <span id="recette-status" style="font-weight: 700; font-size: 16px; color: #0d6efd;">Aucune</span>
                    </div>
                </div>
            </div>

            <!-- MOTORS -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-header-title">‚öôÔ∏è Moteurs</h2>
                </div>
                <div class="card-body" style="display: flex; flex-direction: column; gap: 16px;">
                    <!-- SECTION 1: BOUTONS DE COMMANDE -->
                    <div style="border-bottom: 2px solid #e5e7eb; padding-bottom: 12px;">
                        <p style="font-size: 12px; color: #6b7280; margin: 0 0 10px 0; font-weight: 600;">üì§ COMMANDES (Envoyer l'ordre)</p>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <button id="btn-motA" class="btn btn-primary" style="width: 100%; padding: 8px; font-size: 13px;" <% if (niveau === '0') { %>disabled<% } %>>Moteur A - ‚úó OFF</button>
                            <button id="btn-motB" class="btn btn-primary" style="width: 100%; padding: 8px; font-size: 13px;" <% if (niveau === '0') { %>disabled<% } %>>Moteur B - ‚úó OFF</button>
                            <button id="btn-motC" class="btn btn-primary" style="width: 100%; padding: 8px; font-size: 13px;" <% if (niveau === '0') { %>disabled<% } %>>Moteur C - ‚úó OFF</button>
                        </div>
                    </div>

                    <!-- SECTION 2: √âTATS (MQTT en direct) -->
                    <div>
                        <p style="font-size: 12px; color: #6b7280; margin: 0 0 10px 0; font-weight: 600;">üì• √âTATS (Re√ßus du syst√®me)</p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
                            <div style="padding: 10px; background: #f3f4f6; border-radius: 6px; text-align: center;">
                                <p style="margin: 0 0 6px 0; font-size: 12px; color: #6b7280;">Moteur A</p>
                                <span style="font-size: 14px; font-weight: 700; color: white; background: #ef4444; padding: 6px 10px; border-radius: 4px; display: inline-block;" id="status-motA">OFF</span>
                            </div>
                            <div style="padding: 10px; background: #f3f4f6; border-radius: 6px; text-align: center;">
                                <p style="margin: 0 0 6px 0; font-size: 12px; color: #6b7280;">Moteur B</p>
                                <span style="font-size: 14px; font-weight: 700; color: white; background: #ef4444; padding: 6px 10px; border-radius: 4px; display: inline-block;" id="status-motB">OFF</span>
                            </div>
                            <div style="padding: 10px; background: #f3f4f6; border-radius: 6px; text-align: center;">
                                <p style="margin: 0 0 6px 0; font-size: 12px; color: #6b7280;">Moteur C</p>
                                <span style="font-size: 14px; font-weight: 700; color: white; background: #ef4444; padding: 6px 10px; border-radius: 4px; display: inline-block;" id="status-motC">OFF</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RECIPE FORM -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-header-title">üìù Recette Personnalis√©e</h2>
                </div>
                <div class="card-body">
                    <form id="recipe-form" style="display: flex; flex-direction: column; gap: 12px;">
                        <div class="form-group">
                            <label class="form-label">Ingr√©dient 1</label>
                            <input type="number" class="form-control" id="ing1" placeholder="0" min="0" max="100" <% if (niveau === '0') { %>disabled<% } %>>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ingr√©dient 2</label>
                            <input type="number" class="form-control" id="ing2" placeholder="0" min="0" max="100" <% if (niveau === '0') { %>disabled<% } %>>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ingr√©dient 3</label>
                            <input type="number" class="form-control" id="ing3" placeholder="0" min="0" max="100" <% if (niveau === '0') { %>disabled<% } %>>
                        </div>
                        <button type="submit" class="btn btn-success" <% if (niveau === '0') { %>disabled<% } %>>‚úì Valider Recette</button>
                    </form>
                </div>
            </div>

        </div>

        <!-- COLUMN 2: ASPIRATEUR -->
        <div style="display: flex; flex-direction: column; gap: 16px;">

            <!-- STATE -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-header-title">üí® √âtat Aspirateur</h2>
                </div>
                <div class="card-body">
                    <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #f3f4f6; border-radius: 8px;">
                        <span style="font-size: 14px; font-weight: 500; color: #6b7280;">Sequence :</span>
                        <span id="aspirateur-status" style="font-weight: 700; font-size: 16px; color: #198754;">OFF</span>
                    </div>
                </div>
            </div>

            <!-- LEVELS -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-header-title">üè∫ Niveaux Cylindres</h2>
                </div>
                <div class="card-body" style="display: flex; flex-direction: column; gap: 12px;">
                    <div>
                        <div style="font-size: 11px; font-weight: 600; color: #6b7280; margin-bottom: 4px;">Cylindre A</div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="flex: 1; height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden;">
                                <div id="progress-cyl-a" style="height: 100%; background: linear-gradient(90deg, #0dcaf0, #0ba5e9); width: 0%;"></div>
                            </div>
                            <span style="font-weight: 700; font-size: 14px; color: #0dcaf0; min-width: 40px; text-align: right;" id="val-cyl-a">0%</span>
                        </div>
                    </div>
                    <div>
                        <div style="font-size: 11px; font-weight: 600; color: #6b7280; margin-bottom: 4px;">Cylindre B</div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="flex: 1; height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden;">
                                <div id="progress-cyl-b" style="height: 100%; background: linear-gradient(90deg, #0dcaf0, #0ba5e9); width: 0%;"></div>
                            </div>
                            <span style="font-weight: 700; font-size: 14px; color: #0dcaf0; min-width: 40px; text-align: right;" id="val-cyl-b">0%</span>
                        </div>
                    </div>
                    <div>
                        <div style="font-size: 11px; font-weight: 600; color: #6b7280; margin-bottom: 4px;">Cylindre C</div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="flex: 1; height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden;">
                                <div id="progress-cyl-c" style="height: 100%; background: linear-gradient(90deg, #0dcaf0, #0ba5e9); width: 0%;"></div>
                            </div>
                            <span style="font-weight: 700; font-size: 14px; color: #0dcaf0; min-width: 40px; text-align: right;" id="val-cyl-c">0%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- FORCE BUTTON -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-header-title">üéÆ Commandes</h2>
                </div>
                <div class="card-body">
                    <button id="btn-force" class="btn btn-danger" style="width: 100%;" <% if (niveau === '0') { %>disabled<% } %>>
                        üí™ Force
                    </button>
                </div>
            </div>

        </div>

    </div>

    <!-- FOOTER -->
    <footer style="background: white; border-top: 1px solid #e5e7eb; padding: 16px 24px; text-align: center; margin-top: 24px; color: #6b7280; font-size: 12px;">
        <%- include('../partials/footer') %>
    </footer>

    <script>
        const socket = io();
        const niveau = '<%= niveau %>';
        const canWrite = niveau !== '0';

        // DONN√âES LOCALES - ce qu'on a ENVOY√â aux moteurs
        let localMotorState = {
            motA: 'off',
            motB: 'off',
            motC: 'off'
        };

        // DONN√âES MQTT - ce que le syst√®me RE√áOIT et ENVOIE
        let melangeurData = {
            motA: 'off',
            motB: 'off',
            motC: 'off',
            mode: 'auto',
            recetteStatus: 'AUCUNE'
        };

        let aspirteurData = {
            sequence: 'off',
            cylA: 0,
            cylB: 0,
            cylC: 0
        };

        // CONNECTION STATUS
        socket.on('connect', () =>
        {
            console.log('‚úÖ Connected to Socket.IO');
            const badge = document.getElementById('connection-status');
            if (badge)
            {
                badge.textContent = 'En ligne';
                badge.style.backgroundColor = '#198754';
            }

            // IMPORTANT: Rejoindre les rooms pour recevoir les donn√©es initiales
            socket.emit('join-pi2');
            socket.emit('join-pi4');
        });

        socket.on('disconnect', () =>
        {
            const badge = document.getElementById('connection-status');
            if (badge)
            {
                badge.textContent = 'Hors ligne';
                badge.style.backgroundColor = '#ef4444';
            }
        });

        // MELANGEUR DATA (Pi 2)
        socket.on('mqtt-initial-data-pi2', (data) =>
        {
            Object.assign(melangeurData, data);
            updateMelangeurDisplay();
        });

        socket.on('mqtt-data-pi2', (msg) =>
        {
            if (msg.key && msg.value !== undefined)
            {
                melangeurData[msg.key] = msg.value;
                updateMelangeurDisplay();
            }
        });

        // ASPIRATEUR DATA (Pi 4)
        socket.on('mqtt-initial-data-pi4', (data) =>
        {
            Object.assign(aspirteurData, data);
            updateAspirateurDisplay();
        });

        socket.on('mqtt-data-pi4', (msg) =>
        {
            if (msg.key && msg.value !== undefined)
            {
                aspirteurData[msg.key] = msg.value;
                updateAspirateurDisplay();
            }
        });

        function updateMelangeurDisplay()
        {
            // Motors
            ['A', 'B', 'C'].forEach(motor =>
            {
                const key = `mot${motor}`; // motA, motB, motC
                const btn = document.getElementById(`btn-mot${motor}`);
                const status = document.getElementById(`status-mot${motor}`);

                // Update BUTTON - affiche l'√©tat LOCAL (ce qu'on a envoy√©)
                if (btn && localMotorState[key] !== undefined)
                {
                    btn.textContent = `Moteur ${motor} - ${localMotorState[key].toUpperCase()}`;
                    btn.classList.toggle('btn-danger', localMotorState[key] === 'on');
                    btn.classList.toggle('btn-primary', localMotorState[key] === 'off');

                    if (localMotorState[key] === 'on')
                    {
                        btn.style.backgroundColor = '#dc3545 !important';
                        btn.style.borderColor = '#dc3545 !important';
                    }
                    else
                    {
                        btn.style.backgroundColor = '#0d6efd !important';
                        btn.style.borderColor = '#0d6efd !important';
                    }
                }

                // Update BADGE - affiche l'√©tat MQTT uniquement (re√ßu du syst√®me)
                if (status && melangeurData[key] !== undefined)
                {
                    status.textContent = melangeurData[key].toUpperCase();
                    status.style.backgroundColor = melangeurData[key] === 'on' ? '#198754' : '#ef4444';
                    status.style.color = 'white';
                }
            });

            // Recipe Status
            if (melangeurData.recetteStatus !== undefined)
            {
                const el = document.getElementById('recette-status');
                if (el)
                {
                    el.textContent = melangeurData.recetteStatus || 'Aucune';
                    el.style.color = melangeurData.recetteStatus === 'AUCUNE' ? '#0d6efd' :
                        melangeurData.recetteStatus.includes('FINISH') ? '#198754' : '#ffc107';
                }
            }
        }

        function updateAspirateurDisplay()
        {
            // Sequence Status
            if (aspirteurData.sequence !== undefined)
            {
                const el = document.getElementById('aspirateur-status');
                if (el)
                {
                    el.textContent = (aspirteurData.sequence || 'OFF').toUpperCase();
                    el.style.color = aspirteurData.sequence === 'off' ? '#ef4444' : '#198754';
                }
            }

            // Cylinder Levels
            ['A', 'B', 'C'].forEach(cyl =>
            {
                const key = `cyl${cyl}`.toLowerCase();
                const val = aspirteurData[key];
                if (val !== undefined)
                {
                    const display = document.getElementById(`val-cyl-${cyl.toLowerCase()}`);
                    if (display) display.textContent = val + '%';
                    const prog = document.getElementById(`progress-cyl-${cyl.toLowerCase()}`);
                    if (prog) prog.style.width = val + '%';
                }
            });
        }

        // EVENT LISTENERS - MOTOR BUTTONS
        ['A', 'B', 'C'].forEach(motor =>
        {
            const btn = document.getElementById(`btn-mot${motor}`);
            if (btn)
            {
                btn.addEventListener('click', () =>
                {
                    if (!canWrite) return;

                    const key = `mot${motor}`; // motA, motB, motC
                    // Get CURRENT state from LOCAL state (ce qu'on a envoy√©)
                    const currentState = localMotorState[key] || 'off';
                    const newState = currentState === 'off' ? 'on' : 'off';

                    // Update localMotorState (l'√©tat LOCAL que NOUS contr√¥lons)
                    localMotorState[key] = newState;

                    // Update UI immediately - le bouton affiche notre commande
                    updateMelangeurDisplay();

                    // Publish the command to MQTT (envoyer au syst√®me)
                    socket.emit('mqtt-publish',
                    {
                        topic: `RAM/melangeur/cmd/mot${motor}`,
                        message: newState
                    });
                });
            }
        });

        // FORCE BUTTON - ASPIRATEUR
        const btnForce = document.getElementById('btn-force');
        if (btnForce)
        {
            btnForce.addEventListener('click', () =>
            {
                socket.emit('mqtt-publish',
                {
                    topic: 'RAM/aspirateur/cmd/force',
                    message: '1'
                });
            });
        }

        // RECIPE FORM
        const recipeForm = document.getElementById('recipe-form');
        if (recipeForm)
        {
            recipeForm.addEventListener('submit', (e) =>
            {
                e.preventDefault();
                if (!canWrite) return;

                const ing1 = document.getElementById('ing1').value || '0';
                const ing2 = document.getElementById('ing2').value || '0';
                const ing3 = document.getElementById('ing3').value || '0';
                const recipe = `${ing1},${ing2},${ing3}`;

                socket.emit('mqtt-publish',
                {
                    topic: 'RAM/melangeur/cmd/recette',
                    message: recipe
                });

                // Clear form
                document.getElementById('ing1').value = '';
                document.getElementById('ing2').value = '';
                document.getElementById('ing3').value = '';
            });
        }

    </script>

</body>
</html>
