<!--
* @file granulaires.ejs
* @author charles-Antoine Gagnon
* @version 4 - Simplifié avec jQuery et partials
* @date 11/11/2025
* @brief Granudoseur Control - Mélangeur & Aspirateur
-->
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PanneauRAM - Granudoseur</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/stylesheets/modern.css">
    <link rel="stylesheet" href="/stylesheets/ui-components.css">
    <link rel="stylesheet" href="/stylesheets/granulaires.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body style="margin: 0; padding: 0; background: #f8f9fa;">

    <%- include('../partials/header', { currentPage: 'granulaires', user, niveau, typeAcces }) %>

    <!-- MAIN CONTENT: 2 COLUMNS -->
    <div class="granulaires-grid">

        <!-- COLUMN 1: MELANGEUR -->
        <div class="section-column">

            <!-- État Mélangeur -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-header-title"> État Mélangeur</h2>
                </div>
                <div class="card-body">
                    <div class="status-display">
                        <span class="status-label">Recette Actuelle :</span>
                        <span id="recette-status" class="status-value" style="color: #0d6efd;">Aucune</span>
                    </div>
                </div>
            </div>

            <!-- Moteurs -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-header-title"> Moteurs</h2>
                </div>
                <div class="card-body" style="display: flex; flex-direction: column; gap: 16px;">
                    <!-- Commandes -->
                    <div class="motors-section">
                        <p class="section-title"> COMMANDES (Envoyer l'ordre)</p>
                        <div class="motors-buttons">
                            <% ['A', 'B', 'C'].forEach(motor => { %>
                            <button id="btn-mot<%= motor %>" class="btn btn-primary motor-btn" data-motor="<%= motor.toLowerCase() %>" <% if (niveau === '0') { %>disabled<% } %>>
                                Moteur <%= motor %> - OFF
                            </button>
                            <% }); %>
                        </div>
                    </div>

                    <!-- États MQTT -->
                    <div>
                        <p class="section-title"> ÉTATS (Reçus du système)</p>
                        <div class="motors-status-grid">
                            <% ['A', 'B', 'C'].forEach(motor => { %>
                            <div class="motor-status-card">
                                <p class="motor-status-label">Moteur <%= motor %></p>
                                <span class="motor-status-badge off" id="status-mot<%= motor %>">OFF</span>
                            </div>
                            <% }); %>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recette -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-header-title"> Recette Personnalisée</h2>
                </div>
                <div class="card-body">
                    <form id="recipe-form" class="recipe-form">
                        <% for(let i = 1; i <= 3; i++) { %>
                        <div class="form-group">
                            <label class="form-label">Ingrédient <%= i %></label>
                            <input type="number" class="form-control" id="ing<%= i %>" placeholder="0" min="0" max="100" <% if (niveau === '0') { %>disabled<% } %>>
                        </div>
                        <% } %>
                        <button type="submit" class="btn btn-success" <% if (niveau === '0') { %>disabled<% } %>> Valider Recette</button>
                    </form>
                </div>
            </div>

        </div>

        <!-- COLUMN 2: ASPIRATEUR -->
        <div class="section-column">

            <!-- État Aspirateur -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-header-title"> État Aspirateur</h2>
                </div>
                <div class="card-body">
                    <div class="status-display">
                        <span class="status-label">Sequence :</span>
                        <span id="aspirateur-status" class="status-value" style="color: #198754;">OFF</span>
                    </div>
                </div>
            </div>

            <!-- Niveaux Cylindres -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-header-title"> Niveaux Cylindres</h2>
                </div>
                <div class="card-body">
                    <% ['A', 'B', 'C'].forEach(cyl => { %>
                    <div class="cylinder-item">
                        <div class="cylinder-label">Cylindre <%= cyl %></div>
                        <div class="cylinder-progress-container">
                            <div class="cylinder-progress-bar">
                                <div id="progress-cyl-<%= cyl.toLowerCase() %>" class="cylinder-progress-fill" style="width: 0%;"></div>
                            </div>
                            <span class="cylinder-value" id="val-cyl-<%= cyl.toLowerCase() %>">0%</span>
                        </div>
                    </div>
                    <% }); %>
                </div>
            </div>

            <!-- Commandes -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-header-title"> Commandes</h2>
                </div>
                <div class="card-body">
                    <button id="btn-force" class="btn btn-danger" style="width: 100%;" <% if (niveau === '0') { %>disabled<% } %>>
                        Force
                    </button>
                </div>
            </div>

        </div>

    </div>

    <!-- FOOTER -->
    <footer style="background: white; border-top: 1px solid #e5e7eb; padding: 16px 24px; text-align: center; margin-top: 24px; color: #6b7280; font-size: 12px;">
        <%- include('../partials/footer') %>
    </footer>

    <script>
        const socket = io();
        const niveau = '<%= niveau %>';
        const canWrite = niveau !== '0';

        // État local des moteurs (ce qu'on a envoyé)
        const localMotorState = {
            motA: 'off',
            motB: 'off',
            motC: 'off'
        };

        // Données MQTT
        const mqttData = {
            melangeur:
            {
                motA: 'off',
                motB: 'off',
                motC: 'off',
                recetteStatut: 'AUCUNE'
            },
            aspirateur:
            {
                sequence: 'off',
                NivA: 0,
                NivB: 0,
                NivC: 0
            }
        };

        // ===== SOCKET.IO EVENTS =====
        socket.on('connect', () =>
        {
            console.log('Connecté');
            updateConnectionStatus(true);
            socket.emit('join-pi2');
            socket.emit('join-pi4');
        });

        socket.on('disconnect', () => updateConnectionStatus(false));

        // ALARMES - Pop-up pour niveaux 2 et 3
        socket.on('mqtt-data-alarmes', (data) =>
        {
            const niveau = '<%= niveau %>';
            // Vérifier si c'est une alarme qui s'active (niveau 2 ou 3)
            if ((niveau === '2' || niveau === '3') && data.value && data.value.toUpperCase() === 'ON')
            {
                const alarmName = data.key || 'Alarme inconnue';
                const alarmLabels = {
                    'ALR_GB_OVF': 'Grand Bassin - Débordement',
                    'ALR_GB_NIV_MAX': 'Grand Bassin - Niveau Maximum',
                    'ALR_PB_OVF': 'Petit Bassin - Débordement',
                    'ALR_PB_NIV_MAX': 'Petit Bassin - Niveau Maximum',
                    'ALR_CNX_BAL': 'Connexion Balance Perdue',
                    'ALR_CNX_POW': 'Connexion Power Meter Perdue'
                };
                const alarmMessage = alarmLabels[alarmName] || alarmName;
                alert(`ALARME ACTIVÉE\n\n${alarmMessage}\n\nHeure: ${new Date().toLocaleString('fr-CA')}`);
            }
        });

        // MELANGEUR (Pi 2)
        socket.on('mqtt-initial-data-pi2', (data) =>
        {
            $.extend(mqttData.melangeur, data);
            updateMelangeur();
        });

        // MELANGEUR - Recevoir les dernières commandes envoyées
        socket.on('mqtt-initial-commands-pi2', (data) =>
        {
            console.log('Pi2 - Dernières consignes reçues:', data);
            // Restaurer l'état local des moteurs
            if (data.motA) localMotorState.motA = data.motA;
            if (data.motB) localMotorState.motB = data.motB;
            if (data.motC) localMotorState.motC = data.motC;

            // Restaurer les inputs de recette
            if (data.recette) $('#input-recette').val(data.recette);

            updateMelangeur();
        });

        socket.on('mqtt-data-pi2', (msg) =>
        {
            if (msg.key)
            {
                mqttData.melangeur[msg.key] = msg.value;
                updateMelangeur();
            }
        });

        // ASPIRATEUR (Pi 4)
        socket.on('mqtt-initial-data-pi4', (data) =>
        {
            $.extend(mqttData.aspirateur, data);
            updateAspirateur();
        });

        socket.on('mqtt-data-pi4', (msg) =>
        {
            if (msg.key)
            {
                mqttData.aspirateur[msg.key] = msg.value;
                updateAspirateur();
            }
        });

        // ===== UPDATE FUNCTIONS =====
        function updateConnectionStatus(connected)
        {
            $('#connection-status')
                .text(connected ? 'En ligne' : 'Hors ligne')
                .css('background-color', connected ? '#198754' : '#ef4444');
        }

        function updateMelangeur()
        {
            // Mise à jour des boutons (état local)
            ['A', 'B', 'C'].forEach(m =>
            {
                const key = `mot${m}`;
                const btn = $(`#btn-mot${m}`);
                const state = localMotorState[key];
                btn.text(`Moteur ${m} - ${state.toUpperCase()}`)
                    .removeClass('btn-motor-off btn-motor-on')
                    .addClass(state === 'on' ? 'btn-motor-on' : 'btn-motor-off');
            });

            // Mise à jour des badges (état MQTT)
            ['A', 'B', 'C'].forEach(m =>
            {
                const key = `mot${m}`;
                const badge = $(`#status-mot${m}`);
                const state = mqttData.melangeur[key] || 'off';
                badge.text(state.toUpperCase())
                    .removeClass('on off')
                    .addClass(state === 'on' ? 'on' : 'off');
            });

            // Recette status
            const status = mqttData.melangeur.recetteStatut || 'Aucune';
            $('#recette-status')
                .text(status)
                .css('color', status === 'AUCUNE' ? '#0d6efd' :
                    status.includes('FINISH') ? '#198754' : '#ffc107');
        }

        function updateAspirateur()
        {
            // Sequence
            const seq = (mqttData.aspirateur.sequence || 'OFF').toUpperCase();
            $('#aspirateur-status')
                .text(seq)
                .css('color', seq === 'OFF' ? '#ef4444' : '#198754');

            // Cylindres
            ['A', 'B', 'C'].forEach(c =>
            {
                const key = `Niv${c}`;
                const val = mqttData.aspirateur[key] || 0;
                $(`#val-cyl-${c.toLowerCase()}`).text(val + '%');
                $(`#progress-cyl-${c.toLowerCase()}`).css('width', val + '%');
            });
        }

        // ===== EVENT HANDLERS =====
        // Moteurs
        $('.motor-btn').click(function()
        {
            if (!canWrite) return;

            const motor = $(this).data('motor'); // 'a', 'b', 'c'
            const key = `mot${motor.toUpperCase()}`;
            const currentState = localMotorState[key];
            const newState = currentState === 'off' ? 'on' : 'off';

            localMotorState[key] = newState;
            updateMelangeur();

            // FIX: Utiliser le bon événement socket
            socket.emit('mqtt-command-pi2-motor',
            {
                motor: key,
                value: newState
            });
        });

        // Force
        $('#btn-force').click(() =>
        {
            if (!canWrite) return;
            socket.emit('mqtt-command-pi4-force',
            {
                value: '1'
            });
        });

        // Recette
        $('#recipe-form').submit(function(e)
        {
            e.preventDefault();
            if (!canWrite) return;

            const recipe = [1, 2, 3].map(i => $(`#ing${i}`).val() || '0').join(',');
            socket.emit('mqtt-command-pi2-recette',
            {
                value: recipe
            });

            // Clear form
            $(this).trigger('reset');
        });

    </script>

</body>
</html>
