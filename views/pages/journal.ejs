<!--
* @file journal.ejs
* @author charles-Antoine Gagnon
* @version 1 - Journal page
* @date 11/11/2025
* @brief Page Journal (stub)
-->
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PanneauRAM - Journal</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/stylesheets/modern.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body style="margin: 0; padding: 0; background: #f8f9fa;" data-niveau="<%= niveau %>">

    <%- include('../partials/header', { currentPage: 'journal', user, niveau, typeAcces }) %>

    <!-- ===== CONTENU ===== -->
    <div style="padding: 32px 24px;">
        <div style="max-width: 1600px; margin: 0 auto;">

            <!-- Filtres -->
            <div class="card" style="margin-bottom: 24px;">
                <div class="card-header">
                    <h3 class="card-header-title">Filtres de recherche</h3>
                </div>
                <div class="card-body">
                    <form id="filter-form">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                            <div>
                                <label class="form-label">Date début</label>
                                <input type="datetime-local" id="start-date" class="form-control">
                            </div>
                            <div>
                                <label class="form-label">Date fin</label>
                                <input type="datetime-local" id="end-date" class="form-control">
                            </div>
                            <div>
                                <label class="form-label">Utilisateur</label>
                                <select id="user-filter" class="form-control">
                                    <option value="">-- Tous les utilisateurs --</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label">Type</label>
                                <select id="type-filter" class="form-control">
                                    <option value="">Tous</option>
                                    <option value="LOG_CMD">Commandes</option>
                                    <option value="LOG_ALARME">Alarmes</option>
                                </select>
                            </div>
                        </div>
                        <div style="display: flex; gap: 12px; margin-top: 16px;">
                            <button type="submit" class="btn btn-primary">Filtrer</button>
                            <button type="button" id="btn-reset" class="btn">Réinitialiser</button>
                            <button type="button" id="btn-export" class="btn">Exporter CSV</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Table du journal -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-header-title">Journal des Événements</h2>
                </div>
                <div class="card-body" style="padding: 0; overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                            <tr>
                                <th style="padding: 12px; text-align: left; font-weight: 600; width: 80px;">ID</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; width: 120px;">Type</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; width: 150px;">Utilisateur</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; width: 180px;">Date/Heure</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600;">Information</th>
                            </tr>
                        </thead>
                        <tbody id="journal-tbody">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 40px; color: #6b7280;">
                                    Chargement...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <footer style="background: white; border-top: 1px solid #e5e7eb; padding: 16px 24px; text-align: center; margin-top: 24px; color: #6b7280; font-size: 12px;">
        <%- include('../partials/footer') %>
    </footer>

    <script>
        const socket = io();
        const niveau = document.body.dataset.niveau || '0';
        const urlParams = new URLSearchParams(window.location.search);
        const currentUser = urlParams.get('user') || '<%= user %>';

        socket.on('mqtt-data-alarmes', (data) =>
        {
            if ((niveau === '2' || niveau === '3') && data.value && (data.value === 'ON' || data.value === '1' || data.value === 1))
            {
                if (typeof window.showAlarmNotification === 'function')
                {
                    window.showAlarmNotification(data.key);
                }
            }
        });

        window.showAlarmNotification = function(alarmKey)
        {
            const alarmLabels = {
                'ALR_GB_OVF': 'Grand Bassin - Débordement',
                'ALR_GB_NIV_MAX': 'Grand Bassin - Niveau Maximum',
                'ALR_PB_OVF': 'Petit Bassin - Débordement',
                'ALR_PB_NIV_MAX': 'Petit Bassin - Niveau Maximum',
                'ALR_CNX_BAL': 'Connexion Balance Perdue',
                'ALR_CNX_POW': 'Connexion Power Meter Perdue'
            };
            const label = alarmLabels[alarmKey] || alarmKey;
            const reqTime = new Date().toISOString();
            const notification = document.createElement('div');
            notification.className = 'alarm-notification';
            notification.setAttribute('data-alarm-key', alarmKey);
            notification.setAttribute('data-req-time', reqTime);
            notification.innerHTML = `
                <div style="background: #dc2626; color: white; padding: 16px; border-radius: 8px; margin: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 24px;">!</span>
                        <div style="flex: 1;">
                            <strong style="font-size: 16px;">ALARME DÉCLENCHÉE</strong>
                            <div style="font-size: 14px; margin-top: 4px;">${label}</div>
                            <div style="font-size: 12px; margin-top: 4px; opacity: 0.9;">Le système va tenter de corriger automatiquement</div>
                        </div>
                        <button onclick="acknowledgeAlarm('${alarmKey}')" style="background: #f59e0b; border: none; color: white; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 600;">ACK</button>
                    </div>
                </div>
            `;
            let container = document.getElementById('alarm-notifications');
            if (!container)
            {
                container = document.createElement('div');
                container.id = 'alarm-notifications';
                container.style.cssText = 'position: fixed; top: 80px; right: 20px; z-index: 1000; max-width: 400px;';
                document.body.appendChild(container);
            }
            container.appendChild(notification);
            setTimeout(() =>
            {
                notification.remove();
            }, 10000);
        };

        window.acknowledgeAlarm = function(alarmKey)
        {
            const notifications = document.querySelectorAll(`[data-alarm-key="${alarmKey}"]`);
            if (notifications.length === 0) return;
            notifications.forEach(notification =>
            {
                const reqTime = notification.getAttribute('data-req-time');
                socket.emit('mqtt-acknowledge-alarm',
                {
                    alarmType: alarmKey,
                    user: currentUser,
                    reqTime: reqTime
                });
                notification.remove();
            });
            console.log(`Alarme ${alarmKey} reconnue par ${currentUser}`);
        };

    </script>
    <script src="/scripts/journal-script.js"></script>

</body>
</html>
