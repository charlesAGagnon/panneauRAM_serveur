<!--
* @file home.ejs
* @author charles-Antoine Gagnon
* @version 1 - Modern HOME page
* @date 11/11/2025
* @brief Accueil avec navbar compl√®te et vid√©o live
-->
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PanneauRAM - Accueil</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/stylesheets/modern.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body style="margin: 0; padding: 0; background: #f8f9fa;">

    <!-- ===== NAVBAR ===== -->
    <nav class="navbar-modern">
        <div class="navbar-modern-container">
            <!-- Logo -->
            <a href="/home?user=<%= user %>&niveau=<%= niveau %>&typeAcces=<%= typeAcces %>" class="navbar-brand-modern">
                üéõÔ∏è PanneauRAM
            </a>

            <!-- Menu Principal -->
            <ul class="navbar-menu">
                <li class="navbar-menu-item">
                    <a href="/home?user=<%= user %>&niveau=<%= niveau %>&typeAcces=<%= typeAcces %>" class="navbar-menu-link active">
                        üè† Accueil
                    </a>
                </li>
                <li class="navbar-menu-item">
                    <a href="/dashboard?user=<%= user %>&niveau=<%= niveau %>&typeAcces=<%= typeAcces %>" class="navbar-menu-link">
                        üìä RAM (Panneau)
                    </a>
                </li>
                <li class="navbar-menu-item">
                    <a href="/granulaires?user=<%= user %>&niveau=<%= niveau %>&typeAcces=<%= typeAcces %>" class="navbar-menu-link">
                        üåæ Granudoseur
                    </a>
                </li>
                <li class="navbar-menu-item">
                    <a href="/journal?user=<%= user %>&niveau=<%= niveau %>&typeAcces=<%= typeAcces %>" class="navbar-menu-link">
                        üìã Journal
                    </a>
                </li>
                <li class="navbar-menu-item">
                    <a href="/alertes?user=<%= user %>&niveau=<%= niveau %>&typeAcces=<%= typeAcces %>" class="navbar-menu-link">
                        üîî Alertes
                    </a>
                </li>
                <% if (niveau !== '0') { %>
                <li class="navbar-menu-item">
                    <a href="/comptes?user=<%= user %>&niveau=<%= niveau %>&typeAcces=<%= typeAcces %>" class="navbar-menu-link">
                        üë• Comptes
                    </a>
                </li>
                <% } %>
            </ul>

            <!-- Droite: Utilisateur et D√©connexion -->
            <div class="navbar-right">
                <div class="navbar-user">
                    <span id="connection-status" class="navbar-badge" style="background-color: #ef4444;">Hors ligne</span>
                    <span style="margin-left: 8px;">
                        <strong><%= user %></strong> ‚Ä¢ <%= typeAcces %> (L<%= niveau %>)
                        <% if (niveau === '0') { %>
                        <span style="display: inline-block; margin-left: 8px; background: #0dcaf0; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">üîí R/O</span>
                        <% } %>
                    </span>
                </div>
                <a href="/" class="navbar-logout">D√©connexion</a>
            </div>
        </div>
    </nav>

    <!-- ===== CONTENU PRINCIPAL ===== -->
    <div style="padding: 32px 24px;">
        <div style="max-width: 1400px; margin: 0 auto;">

            <!-- ===== JUMBOTRON ===== -->
            <div class="jumbotron">
                <h1 class="jumbotron-title">üéØ Bienvenue, <%= user %>!</h1>
                <p class="jumbotron-subtitle">Tableau de bord central - Monitoring en temps r√©el de votre syst√®me PanneauRAM</p>
                <div class="jumbotron-cta">
                    <a href="/dashboard?user=<%= user %>&niveau=<%= niveau %>&typeAcces=<%= typeAcces %>" class="btn btn-primary">
                        Acc√©der au Panneau RAM
                    </a>
                    <a href="/granulaires?user=<%= user %>&niveau=<%= niveau %>&typeAcces=<%= typeAcces %>" class="btn btn-primary" style="background: #198754;">
                        Aller au Granudoseur
                    </a>
                </div>
            </div>

            <!-- ===== VID√âO / CANVAS ===== -->
            <% if (niveau !== '0') { %>
            <div class="card mb-3" style="margin-bottom: 32px;">
                <div class="card-header">
                    <h2 class="card-header-title">üìπ Flux Vid√©o Live</h2>
                </div>
                <div class="card-body p-0" style="padding: 0;">
                    <div class="video-container">
                        <canvas id="video-canvas" style="width: 100%; height: auto; max-height: 600px;"></canvas>
                        <div class="video-overlay">‚óè LIVE</div>
                    </div>
                </div>
            </div>
            <% } else { %>
            <div class="alert alert-info" style="margin-bottom: 32px;">
                <strong>‚ÑπÔ∏è Acc√®s limit√© en lecture seule</strong><br>
                Vous pouvez consulter les donn√©es en temps r√©el, mais vous n'avez pas la permission de modifier les configurations. Contactez un administrateur pour plus d'acc√®s.
            </div>
            <% } %>

            <!-- ===== STATUT SYST√àME ===== -->
            <div style="margin-bottom: 32px;">
                <h2 style="font-size: 18px; font-weight: 700; margin-bottom: 16px; color: #212529;">üìä √âtat du Syst√®me</h2>
                <div class="grid grid-cols-3" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px;">

                    <!-- R√©servoirs -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-header-title">üè∫ R√©servoirs</h3>
                        </div>
                        <div class="card-body">
                            <div class="stat-card" style="margin-bottom: 12px;">
                                <div class="stat-label">Niv GB</div>
                                <div class="stat-value" id="stat-niv-gb">--</div>
                                <div class="stat-unit">%</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Niv PB</div>
                                <div class="stat-value" id="stat-niv-pb">--</div>
                                <div class="stat-unit">%</div>
                            </div>
                        </div>
                    </div>

                    <!-- Temp√©rature -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-header-title">üå°Ô∏è Temp√©rature</h3>
                        </div>
                        <div class="card-body">
                            <div class="stat-card">
                                <div class="stat-label">Temp PB</div>
                                <div class="stat-value" id="stat-temp-pb">--</div>
                                <div class="stat-unit">¬∞C</div>
                            </div>
                        </div>
                    </div>

                    <!-- √ânergie -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-header-title">‚ö° √ânergie</h3>
                        </div>
                        <div class="card-body">
                            <div class="stat-card" style="margin-bottom: 12px;">
                                <div class="stat-label">Puissance</div>
                                <div class="stat-value" id="stat-kw">--</div>
                                <div class="stat-unit">kW</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Consommation</div>
                                <div class="stat-value" id="stat-kwh">--</div>
                                <div class="stat-unit">kWh</div>
                            </div>
                        </div>
                    </div>

                    <!-- M√©langeur -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-header-title">üéõÔ∏è M√©langeur</h3>
                        </div>
                        <div class="card-body">
                            <div class="stat-card">
                                <div class="stat-label">Recette Status</div>
                                <div style="font-size: 14px; font-weight: 700; margin-top: 8px; color: #198754;" id="stat-recette-status">FINISHED</div>
                            </div>
                        </div>
                    </div>

                    <!-- Aspirateur -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-header-title">üí® Aspirateur</h3>
                        </div>
                        <div class="card-body">
                            <div class="stat-card">
                                <div class="stat-label">S√©quence</div>
                                <div style="font-size: 14px; font-weight: 700; margin-top: 8px; color: #198754;" id="stat-aspirateur-seq">FINISHED</div>
                            </div>
                        </div>
                    </div>

                    <!-- Connexion -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-header-title">üîó Connectivit√©</h3>
                        </div>
                        <div class="card-body">
                            <div class="stat-card">
                                <div class="stat-label">√âtat MQTT</div>
                                <div style="font-size: 14px; font-weight: 700; margin-top: 8px; color: #ef4444;" id="stat-mqtt-status">Hors ligne</div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- ===== INFORMATION UTILISATEUR ===== -->
            <div style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 16px;">‚ÑπÔ∏è Informations de Compte</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                    <div>
                        <label style="font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase;">Nom d'utilisateur</label>
                        <p style="font-size: 16px; font-weight: 700; margin-top: 4px;"><%= user %></p>
                    </div>
                    <div>
                        <label style="font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase;">Type d'acc√®s</label>
                        <p style="font-size: 16px; font-weight: 700; margin-top: 4px;"><%= typeAcces %></p>
                    </div>
                    <div>
                        <label style="font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase;">Niveau</label>
                        <p style="font-size: 16px; font-weight: 700; margin-top: 4px;">
                            <span class="badge badge-info">Niveau <%= niveau %></span>
                        </p>
                    </div>
                    <div>
                        <label style="font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase;">Permissions</label>
                        <p style="font-size: 16px; font-weight: 700; margin-top: 4px;">
                            <% if (niveau === '0') { %>
                            <span class="badge badge-info">Lecture seule</span>
                            <% } else if (niveau === '1') { %>
                            <span class="badge" style="background: #198754; color: white;">Op√©rateur</span>
                            <% } else if (niveau === '2') { %>
                            <span class="badge" style="background: #0d6efd; color: white;">Superviseur</span>
                            <% } else { %>
                            <span class="badge badge-danger">Administrateur</span>
                            <% } %>
                        </p>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- ===== FOOTER ===== -->
    <footer style="background: white; border-top: 1px solid #e5e7eb; padding: 24px; text-align: center; margin-top: 40px; color: #6b7280; font-size: 12px;">
        <%- include('../partials/footer') %>
    </footer>

    <script>
        const socket = io();
        const niveau = '<%= niveau %>';
        const user = '<%= user %>';
        const canWrite = niveau !== '0';

        // Connexion Socket.IO
        socket.on('connect', () =>
        {
            console.log('‚úÖ Connect√© √† Socket.IO');
            const statusBadge = document.getElementById('connection-status');
            if (statusBadge)
            {
                statusBadge.textContent = 'En ligne';
                statusBadge.style.backgroundColor = '#198754';
            }
            const mqttStatus = document.getElementById('stat-mqtt-status');
            if (mqttStatus)
            {
                mqttStatus.textContent = 'En ligne';
                mqttStatus.style.color = '#198754';
            }
        });

        socket.on('disconnect', () =>
        {
            console.log('‚ùå D√©connect√© de Socket.IO');
            const statusBadge = document.getElementById('connection-status');
            if (statusBadge)
            {
                statusBadge.textContent = 'Hors ligne';
                statusBadge.style.backgroundColor = '#ef4444';
            }
            const mqttStatus = document.getElementById('stat-mqtt-status');
            if (mqttStatus)
            {
                mqttStatus.textContent = 'Hors ligne';
                mqttStatus.style.color = '#ef4444';
            }
        });

        // ===== Donn√©es PANNEAU (Pi Main) =====
        socket.on('mqtt-initial-data', (data) =>
        {
            if (data.NivGB !== undefined) document.getElementById('stat-niv-gb').textContent = data.NivGB;
            if (data.NivPB !== undefined) document.getElementById('stat-niv-pb').textContent = data.NivPB;
            if (data.TmpPB !== undefined) document.getElementById('stat-temp-pb').textContent = data.TmpPB;
        });

        socket.on('mqtt-data', (data) =>
        {
            const
            {
                key,
                value
            } = data;
            if (key === 'NivGB') document.getElementById('stat-niv-gb').textContent = value;
            if (key === 'NivPB') document.getElementById('stat-niv-pb').textContent = value;
            if (key === 'TmpPB') document.getElementById('stat-temp-pb').textContent = value;
        });

        // ===== Donn√©es √âNERGIE (Pi 3) =====
        socket.on('mqtt-initial-data-pi3', (data) =>
        {
            if (data.KW !== undefined) document.getElementById('stat-kw').textContent = (parseFloat(data.KW) || 0).toFixed(2);
            if (data.KWh !== undefined) document.getElementById('stat-kwh').textContent = (parseFloat(data.KWh) || 0).toFixed(2);
        });

        socket.on('mqtt-data-pi3', (data) =>
        {
            const
            {
                key,
                value
            } = data;
            if (key === 'KW') document.getElementById('stat-kw').textContent = (parseFloat(value) || 0).toFixed(2);
            if (key === 'KWh') document.getElementById('stat-kwh').textContent = (parseFloat(value) || 0).toFixed(2);
        });

        // ===== Donn√©es M√âLANGEUR (Pi 2) =====
        socket.on('mqtt-initial-data-pi2', (data) =>
        {
            if (data.recetteStatut !== undefined)
            {
                document.getElementById('stat-recette-status').textContent = data.recetteStatut;
                document.getElementById('stat-recette-status').style.color = data.recetteStatut === 'FINISHED' ? '#198754' : '#ffc107';
            }
        });

        socket.on('mqtt-data-pi2', (data) =>
        {
            const
            {
                key,
                value
            } = data;
            if (key === 'recetteStatut')
            {
                document.getElementById('stat-recette-status').textContent = value;
                document.getElementById('stat-recette-status').style.color = value === 'FINISHED' ? '#198754' : '#ffc107';
            }
        });

        // ===== Donn√©es ASPIRATEUR (Pi 4) =====
        socket.on('mqtt-initial-data-pi4', (data) =>
        {
            if (data.sequence !== undefined)
            {
                document.getElementById('stat-aspirateur-seq').textContent = data.sequence;
                document.getElementById('stat-aspirateur-seq').style.color = data.sequence === 'FINISHED' ? '#198754' : '#ffc107';
            }
        });

        socket.on('mqtt-data-pi4', (data) =>
        {
            const
            {
                key,
                value
            } = data;
            if (key === 'sequence')
            {
                document.getElementById('stat-aspirateur-seq').textContent = value;
                document.getElementById('stat-aspirateur-seq').style.color = value === 'FINISHED' ? '#198754' : '#ffc107';
            }
        });

        // ===== CANVAS VID√âO (si niveau > 0) =====

        if (niveau !== '0')
        {

            const canvas = document.getElementById('video-canvas');
            if (canvas)
            {
                const ctx = canvas.getContext('2d');
                canvas.width = 1280;
                canvas.height = 720;

                // Dessiner un placeholder noir
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Texte de placeholder
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 24px Inter, sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('üìπ Flux vid√©o en direct', canvas.width / 2, canvas.height / 2 - 20);
                ctx.font = '14px Inter, sans-serif';
                ctx.fillStyle = 'rgba(255,255,255,0.7)';
                ctx.fillText('(Connexion cam√©ra en cours...)', canvas.width / 2, canvas.height / 2 + 20);
            }

        }

    </script>

</body>
</html>
