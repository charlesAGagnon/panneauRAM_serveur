<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PanneauRAM - Profils</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/stylesheets/modern.css">
    <link rel="stylesheet" href="/stylesheets/profils.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body style="margin: 0; padding: 0; background: #f8f9fa;" data-niveau="<%= niveau %>">

    <%- include('../partials/header', { currentPage: 'profils', user, niveau, typeAcces }) %>

    <div class="profils-container">
        <!-- Formulaire de création/modification -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-header-title"><span id="form-title">Créer un utilisateur</span></h2>
            </div>
            <div class="card-body">
                <div class="profils-content">
                    <input type="hidden" id="user-id" value="">
                    <div class="form-group">
                        <label class="form-label">Nom d'utilisateur *</label>
                        <input type="text" class="form-control" id="username" placeholder="Entrez le nom d'utilisateur" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Mot de passe *</label>
                        <input type="password" class="form-control" id="password" placeholder="Entrez le mot de passe" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Niveau d'accès *</label>
                        <select class="form-control" id="niveau" required>
                            <option value="0">Invité (Lecture seule)</option>
                            <option value="1">Utilisateur</option>
                            <option value="2">Modérateur</option>
                            <option value="3">Administrateur</option>
                        </select>
                    </div>
                    <div class="button-group">
                        <button class="btn btn-primary" id="save-profile">Enregistrer</button>
                        <button class="btn btn-secondary" id="cancel-edit" style="display: none;">Annuler</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Liste des utilisateurs -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-header-title">Liste des utilisateurs</h2>
            </div>
            <div class="card-body">
                <div id="users-list"></div>
            </div>
        </div>
    </div>

    <footer style="background: white; border-top: 1px solid #e5e7eb; padding: 16px 24px; text-align: center; margin-top: 24px; color: #6b7280; font-size: 12px;">
        <%- include('../partials/footer') %>
    </footer>

    <script>
        const socket = io();
        const niveau = document.body.dataset.niveau || '0';
        const urlParams = new URLSearchParams(window.location.search);
        const currentUser = urlParams.get('user') || '<%= user %>';

        socket.on('mqtt-data-alarmes', (data) =>
        {
            if ((niveau === '2' || niveau === '3') && data.value && (data.value === 'ON' || data.value === '1' || data.value === 1))
            {
                if (typeof window.showAlarmNotification === 'function')
                {
                    window.showAlarmNotification(data.key);
                }
            }
        });

        window.showAlarmNotification = function(alarmKey)
        {
            const alarmLabels = {
                'ALR_GB_OVF': 'Grand Bassin - Débordement',
                'ALR_GB_NIV_MAX': 'Grand Bassin - Niveau Maximum',
                'ALR_PB_OVF': 'Petit Bassin - Débordement',
                'ALR_PB_NIV_MAX': 'Petit Bassin - Niveau Maximum',
                'ALR_CNX_BAL': 'Connexion Balance Perdue',
                'ALR_CNX_POW': 'Connexion Power Meter Perdue'
            };
            const label = alarmLabels[alarmKey] || alarmKey;
            const reqTime = new Date().toISOString();
            const notification = document.createElement('div');
            notification.className = 'alarm-notification';
            notification.setAttribute('data-alarm-key', alarmKey);
            notification.setAttribute('data-req-time', reqTime);
            notification.innerHTML = `
                <div style="background: #dc2626; color: white; padding: 16px; border-radius: 8px; margin: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 24px;">!</span>
                        <div style="flex: 1;">
                            <strong style="font-size: 16px;">ALARME DÉCLENCHÉE</strong>
                            <div style="font-size: 14px; margin-top: 4px;">${label}</div>
                            <div style="font-size: 12px; margin-top: 4px; opacity: 0.9;">Le système va tenter de corriger automatiquement</div>
                        </div>
                        <button onclick="acknowledgeAlarm('${alarmKey}')" style="background: #f59e0b; border: none; color: white; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 600;">ACK</button>
                    </div>
                </div>
            `;
            let container = document.getElementById('alarm-notifications');
            if (!container)
            {
                container = document.createElement('div');
                container.id = 'alarm-notifications';
                container.style.cssText = 'position: fixed; top: 80px; right: 20px; z-index: 1000; max-width: 400px;';
                document.body.appendChild(container);
            }
            container.appendChild(notification);
            setTimeout(() =>
            {
                notification.remove();
            }, 10000);
        };

        window.acknowledgeAlarm = function(alarmKey)
        {
            const notifications = document.querySelectorAll(`[data-alarm-key="${alarmKey}"]`);
            if (notifications.length === 0) return;
            notifications.forEach(notification =>
            {
                const reqTime = notification.getAttribute('data-req-time');
                socket.emit('mqtt-acknowledge-alarm',
                {
                    alarmType: alarmKey,
                    user: currentUser,
                    reqTime: reqTime
                });
                notification.remove();
            });
            console.log(`Alarme ${alarmKey} reconnue par ${currentUser}`);
        };

    </script>
    <script src="/scripts/profils-script.js"></script>

</body>
</html>
