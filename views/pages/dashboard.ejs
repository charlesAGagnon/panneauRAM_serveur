<!--
* @file dashboard.ejs
* @author charles-Antoine Gagnon
* @version 4 - Modern 3-column layout
* @date 11/11/2025
* @brief RAM Panel - 3 Columns: Graph | Reservoir Status & Controls | Power Meter
-->
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PanneauRAM - Panneau RAM</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/stylesheets/modern.css">
    <link rel="stylesheet" href="/stylesheets/ui-components.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body style="margin: 0; padding: 0; background: #f8f9fa;">

    <%- include('../partials/header', { currentPage: 'dashboard', user, niveau, typeAcces }) %>

    <!-- MAIN CONTENT: 2 COLUMNS -->
    <div style="padding: 24px; display: grid; grid-template-columns: 1fr 1.5fr; gap: 24px;">

        <!-- COLUMN 1: CONTROLS (CONSIGNES) -->
        <div style="display: flex; flex-direction: column; gap: 16px;">

            <!-- CONSIGNES RESERVOIRS -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-header-title"> Consignes Réservoirs</h3>
                </div>
                <div class="card-body">
                    <!-- ConsNivGB (0-100%) - Niveau GB Consigne -->
                    <div style="margin-bottom: 14px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <label class="form-label" style="margin: 0;">Niveau GB</label>
                            <span style="font-weight: 700; font-size: 12px; color: #0d6efd;"><span id="val-slider-gb">0</span>%</span>
                        </div>
                        <input type="range" class="form-control" id="slider-gb" min="0" max="100" value="0" <% if (niveau === '0') { %>disabled<% } %>>
                    </div>

                    <!-- ConsNivPB (0-100%) - Niveau PB Consigne -->
                    <div style="margin-bottom: 14px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <label class="form-label" style="margin: 0;">Niveau PB</label>
                            <span style="font-weight: 700; font-size: 12px; color: #0d6efd;"><span id="val-slider-pb">0</span>%</span>
                        </div>
                        <input type="range" class="form-control" id="slider-pb" min="0" max="100" value="0" <% if (niveau === '0') { %>disabled<% } %>>
                    </div>

                    <!-- ConsTmpPB (0-100°C) - Température PB Consigne -->
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <label class="form-label" style="margin: 0;">Température PB</label>
                            <span style="font-weight: 700; font-size: 12px; color: #0d6efd;"><span id="val-slider-tmpb">0</span>°C</span>
                        </div>
                        <input type="range" class="form-control" id="slider-tmpb" min="0" max="100" value="0" <% if (niveau === '0') { %>disabled<% } %>>
                    </div>
                </div>
            </div>

            <!-- CONSIGNES VANNES -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-header-title"> Consignes Vannes</h3>
                </div>
                <div class="card-body">
                    <!-- ValveGB (0-100%) -->
                    <div style="margin-bottom: 14px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <label class="form-label" style="margin: 0;">Valve GB</label>
                            <span style="font-weight: 700; font-size: 12px; color: #0d6efd;"><span id="val-slider-gb-valve">0</span>%</span>
                        </div>
                        <input type="range" class="form-control" id="slider-gb-valve" min="0" max="100" value="0" <% if (niveau === '0') { %>disabled<% } %>>
                    </div>

                    <!-- ValvePB (0-100%) -->
                    <div style="margin-bottom: 14px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <label class="form-label" style="margin: 0;">Valve PB</label>
                            <span style="font-weight: 700; font-size: 12px; color: #0d6efd;"><span id="val-slider-pb-valve">0</span>%</span>
                        </div>
                        <input type="range" class="form-control" id="slider-pb-valve" min="0" max="100" value="0" <% if (niveau === '0') { %>disabled<% } %>>
                    </div>

                    <!-- ValveEC (0-100) -->
                    <div style="margin-bottom: 14px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <label class="form-label" style="margin: 0;">Valve EC</label>
                            <span style="font-weight: 700; font-size: 12px; color: #0d6efd;"><span id="val-slider-ec">0</span>%</span>
                        </div>
                        <input type="range" class="form-control" id="slider-ec" min="0" max="100" value="0" <% if (niveau === '0') { %>disabled<% } %>>
                    </div>

                    <!-- ValveEF (0-100) -->
                    <div style="margin-bottom: 14px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <label class="form-label" style="margin: 0;">Valve EF</label>
                            <span style="font-weight: 700; font-size: 12px; color: #0d6efd;"><span id="val-slider-ef">0</span>%</span>
                        </div>
                        <input type="range" class="form-control" id="slider-ef" min="0" max="100" value="0" <% if (niveau === '0') { %>disabled<% } %>>
                    </div>

                    <!-- ValveEEC (ON/OFF) -->
                    <div style="margin-bottom: 14px; display: flex; align-items: center; justify-content: space-between; padding: 10px; background: #f3f4f6; border-radius: 6px;">
                        <label style="font-weight: 500; color: #212529; margin: 0;">Valve EEC</label>
                        <button id="btn-eec" class="btn btn-primary" style="min-width: 60px; padding: 6px 12px; font-size: 12px;" <% if (niveau === '0') { %>disabled<% } %>>OFF</button>
                    </div>

                    <!-- ValveEEF (ON/OFF) -->
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; background: #f3f4f6; border-radius: 6px;">
                        <label style="font-weight: 500; color: #212529; margin: 0;">Valve EEF</label>
                        <button id="btn-eef" class="btn btn-primary" style="min-width: 60px; padding: 6px 12px; font-size: 12px;" <% if (niveau === '0') { %>disabled<% } %>>OFF</button>
                    </div>
                </div>
            </div>

            <!-- MODE & PUMP -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-header-title"> Commandes</h3>
                </div>
                <div class="card-body">
                    <div style="margin-bottom: 12px;">
                        <label class="form-label">Mode Système</label>
                        <select id="select-mode" class="form-select" <% if (niveau === '0') { %>disabled<% } %>>
                            <option value="auto">AUTO</option>
                            <option value="manuel">MANUEL</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Pompe</label>
                        <button id="btn-pompe" class="btn btn-primary" style="width: 100%;" <% if (niveau === '0') { %>disabled<% } %>>
                            OFF
                        </button>
                    </div>
                </div>
            </div>

        </div>

        <!-- COLUMN 2: STATUS & POWER METER -->
        <div style="display: flex; flex-direction: column; gap: 16px;">

            <!-- ETATS RECUS (MESURES) -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-header-title"> États Reçus (Mesures)</h3>
                </div>
                <div class="card-body" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                    <!-- Niveaux -->
                    <div class="stat-card">
                        <div class="stat-label">Niv GB</div>
                        <div class="stat-value" id="etat-nivgb" style="font-size: 18px;">--</div>
                        <div class="stat-unit">%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Niv PB</div>
                        <div class="stat-value" id="etat-nivpb" style="font-size: 18px;">--</div>
                        <div class="stat-unit">%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Tmp PB</div>
                        <div class="stat-value" id="etat-tmppb" style="font-size: 18px;">--</div>
                        <div class="stat-unit">°C</div>
                    </div>

                    <!-- Vannes analogiques -->
                    <div class="stat-card">
                        <div class="stat-label">Valve GB</div>
                        <div class="stat-value" id="etat-valvegb" style="font-size: 18px;">--</div>
                        <div class="stat-unit">%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Valve PB</div>
                        <div class="stat-value" id="etat-valvepb" style="font-size: 18px;">--</div>
                        <div class="stat-unit">%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Valve EC</div>
                        <div class="stat-value" id="etat-valveec" style="font-size: 18px;">--</div>
                        <div class="stat-unit">%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Valve EF</div>
                        <div class="stat-value" id="etat-valveef" style="font-size: 18px;">--</div>
                        <div class="stat-unit">%</div>
                    </div>

                    <!-- Vannes numériques et pompe -->
                    <div class="stat-card">
                        <div class="stat-label">Valve EEC</div>
                        <div class="stat-value" id="etat-valveeec" style="font-size: 14px; color: #6b7280;">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Valve EEF</div>
                        <div class="stat-value" id="etat-valveeef" style="font-size: 14px; color: #6b7280;">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Pompe</div>
                        <div class="stat-value" id="etat-pompe" style="font-size: 14px; color: #6b7280;">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Mode</div>
                        <div class="stat-value" id="etat-mode" style="font-size: 14px; color: #6b7280; text-transform: uppercase;">--</div>
                    </div>
                </div>
            </div>

            <!-- ETATS PURGES (Pi 5 - Valves) -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-header-title"> Purges (Ouverture Valves)</h3>
                </div>
                <div class="card-body" style="display: flex; justify-content: space-around; align-items: center; gap: 40px; padding: 30px;">

                    <!-- Jauge Purge GB -->
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
                        <div style="font-weight: 600; font-size: 14px; color: #374151; margin-bottom: 10px;">PURGE GB</div>
                        <div style="position: relative; width: 150px; height: 75px;">
                            <!-- Arc de fond -->
                            <svg width="150" height="75" style="transform: rotate(0deg);">
                                <path d="M 10 65 A 60 60 0 0 1 140 65" fill="none" stroke="#e5e7eb" stroke-width="12" stroke-linecap="round" />
                                <path id="gauge-arc-gb" d="M 10 65 A 60 60 0 0 1 140 65" fill="none" stroke="#3b82f6" stroke-width="12" stroke-linecap="round" stroke-dasharray="188.5" stroke-dashoffset="188.5" style="transition: stroke-dashoffset 0.3s ease;" />
                            </svg>
                            <!-- Valeur au centre -->
                            <div style="position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%); text-align: center;">
                                <div id="etat-purge-gb" style="font-size: 24px; font-weight: 700; color: #3b82f6;">--</div>
                                <div style="font-size: 12px; color: #6b7280; font-weight: 500;">%</div>
                            </div>
                        </div>
                    </div>

                    <!-- Jauge Purge PB -->
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
                        <div style="font-weight: 600; font-size: 14px; color: #374151; margin-bottom: 10px;">PURGE PB</div>
                        <div style="position: relative; width: 150px; height: 75px;">
                            <!-- Arc de fond -->
                            <svg width="150" height="75" style="transform: rotate(0deg);">
                                <path d="M 10 65 A 60 60 0 0 1 140 65" fill="none" stroke="#e5e7eb" stroke-width="12" stroke-linecap="round" />
                                <path id="gauge-arc-pb" d="M 10 65 A 60 60 0 0 1 140 65" fill="none" stroke="#10b981" stroke-width="12" stroke-linecap="round" stroke-dasharray="188.5" stroke-dashoffset="188.5" style="transition: stroke-dashoffset 0.3s ease;" />
                            </svg>
                            <!-- Valeur au centre -->
                            <div style="position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%); text-align: center;">
                                <div id="etat-purge-pb" style="font-size: 24px; font-weight: 700; color: #10b981;">--</div>
                                <div style="font-size: 12px; color: #6b7280; font-weight: 500;">%</div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- RESERVOIRS STATUS - VISUAL CYLINDERS -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-header-title"> Réservoirs (Visualisation)</h3>
                </div>
                <div class="card-body" style="display: flex; justify-content: space-around; align-items: flex-end; gap: 12px; min-height: 200px;">
                    <!-- Cylindre GB -->
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                        <div style="font-size: 10px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">GB</div>
                        <div style="position: relative; width: 50px; height: 120px; border: 2px solid #0d6efd; border-radius: 6px; background: #f0f4ff; overflow: hidden;">
                            <div id="cylinder-gb-fill" style="position: absolute; bottom: 0; width: 100%; height: 0%; background: linear-gradient(180deg, #0d6efd, #0a58ca); transition: height 0.3s ease; border-radius: 4px;"></div>
                        </div>
                        <div style="font-weight: 700; font-size: 16px; color: #0d6efd;" id="val-gb">0%</div>
                    </div>

                    <!-- Cylindre PB -->
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                        <div style="font-size: 10px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">PB</div>
                        <div style="position: relative; width: 50px; height: 120px; border: 2px solid #0d6efd; border-radius: 6px; background: #f0f4ff; overflow: hidden;">
                            <div id="cylinder-pb-fill" style="position: absolute; bottom: 0; width: 100%; height: 0%; background: linear-gradient(180deg, #0d6efd, #0a58ca); transition: height 0.3s ease; border-radius: 4px;"></div>
                        </div>
                        <div style="font-weight: 700; font-size: 16px; color: #0d6efd;" id="val-pb">0%</div>
                    </div>
                </div>
            </div>

            <!-- POWER METER STATS -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-header-title"> Power Meter</h3>
                </div>
                <div class="card-body" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <div class="stat-card">
                        <div class="stat-label">Van</div>
                        <div class="stat-value" id="stat-van" style="font-size: 20px;">--</div>
                        <div class="stat-unit">V</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Vbn</div>
                        <div class="stat-value" id="stat-vbn" style="font-size: 20px;">--</div>
                        <div class="stat-unit">V</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Vab</div>
                        <div class="stat-value" id="stat-vab" style="font-size: 20px;">--</div>
                        <div class="stat-unit">V</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Ia</div>
                        <div class="stat-value" id="stat-ia" style="font-size: 20px;">--</div>
                        <div class="stat-unit">A</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Ib</div>
                        <div class="stat-value" id="stat-ib" style="font-size: 20px;">--</div>
                        <div class="stat-unit">A</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Kw</div>
                        <div class="stat-value" id="stat-kw" style="font-size: 20px;">--</div>
                        <div class="stat-unit">kW</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Kwh</div>
                        <div class="stat-value" id="stat-kwh" style="font-size: 20px;">--</div>
                        <div class="stat-unit">kWh</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Fp</div>
                        <div class="stat-value" id="stat-fp" style="font-size: 20px;">--</div>
                        <div class="stat-unit"></div>
                    </div>
                </div>
            </div>

        </div>

    </div>

    <!-- FOOTER -->
    <footer style="background: white; border-top: 1px solid #e5e7eb; padding: 16px 24px; text-align: center; margin-top: 24px; color: #6b7280; font-size: 12px;">
        <%- include('../partials/footer') %>
    </footer>

    <script>
        document.body.dataset.niveau = '<%= niveau %>';

    </script>
    <script src="/scripts/dashboard-script.js"></script>

</html>
