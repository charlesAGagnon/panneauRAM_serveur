<!--
* @file dashboard.ejs
* @author charles-Antoine Gagnon
* @version 1
* @date 10/11/2025
* @brief Page dashboard commune avec données MQTT en temps réel
-->
<!DOCTYPE html>
<html lang="fr" data-theme="light">
<head>
    <%- include('../partials/head') %>
    <link rel="stylesheet" href="/stylesheets/dashboard-controls.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <div class="min-h-screen py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-7xl mx-auto">
            <!-- Header Card -->
            <div class="card bg-base-100 shadow-2xl mb-6 border-t-4 border-primary">
                <div class="card-body">
                    <div class="flex items-center justify-between flex-wrap gap-4">
                        <div>
                            <h1 class="text-4xl font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">
                                Tableau de bord - <%= user %>
                            </h1>
                            <p class="text-gray-600 mt-2"><%= typeAcces %> - Niveau <%= niveau %></p>
                        </div>
                        <div>
                            <span id="connection-status" class="badge badge-lg">Hors ligne</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Données MQTT en temps réel -->
            <div class="card bg-base-100 shadow-2xl mb-6">
                <div class="card-body">
                    <h2 class="card-title text-2xl mb-6">État du système en temps réel</h2>

                    <!-- Niveaux et Température -->
                    <div class="grid md:grid-cols-3 gap-4 mb-6">
                        <div class="stat bg-base-200 rounded-lg">
                            <div class="stat-title">Niveau Grand Bassin</div>
                            <div class="stat-value" id="nivgb">--%</div>
                            <div class="stat-desc">NivGB</div>
                        </div>
                        <div class="stat bg-base-200 rounded-lg">
                            <div class="stat-title">Niveau Petit Bassin</div>
                            <div class="stat-value" id="nivpb">--%</div>
                            <div class="stat-desc">NivPB</div>
                        </div>
                        <div class="stat bg-base-200 rounded-lg">
                            <div class="stat-title">Température PB</div>
                            <div class="stat-value" id="tmppb">--°C</div>
                            <div class="stat-desc">TmpPB</div>
                        </div>
                    </div>

                    <!-- Valves -->
                    <h3 class="text-xl font-semibold mb-4">Valves (ouverture en %)</h3>
                    <div class="grid md:grid-cols-4 gap-4 mb-6">
                        <div class="stat bg-base-200 rounded-lg">
                            <div class="stat-title">Valve GB</div>
                            <div class="stat-value text-2xl" id="valvegb">--%</div>
                        </div>
                        <div class="stat bg-base-200 rounded-lg">
                            <div class="stat-title">Valve PB</div>
                            <div class="stat-value text-2xl" id="valvepb">--%</div>
                        </div>
                        <div class="stat bg-base-200 rounded-lg">
                            <div class="stat-title">Valve EC</div>
                            <div class="stat-value text-2xl" id="valveec">--%</div>
                        </div>
                        <div class="stat bg-base-200 rounded-lg">
                            <div class="stat-title">Valve EF</div>
                            <div class="stat-value text-2xl" id="valveef">--%</div>
                        </div>
                    </div>

                    <!-- États ON/OFF -->
                    <h3 class="text-xl font-semibold mb-4">États des équipements</h3>
                    <div class="grid md:grid-cols-4 gap-4">
                        <div class="stat bg-base-200 rounded-lg">
                            <div class="stat-title">Valve EEC</div>
                            <div class="stat-value text-2xl">
                                <span id="valveeec" class="badge badge-lg">OFF</span>
                            </div>
                        </div>
                        <div class="stat bg-base-200 rounded-lg">
                            <div class="stat-title">Valve EEF</div>
                            <div class="stat-value text-2xl">
                                <span id="valveeef" class="badge badge-lg">OFF</span>
                            </div>
                        </div>
                        <div class="stat bg-base-200 rounded-lg">
                            <div class="stat-title">Pompe</div>
                            <div class="stat-value text-2xl">
                                <span id="pompe" class="badge badge-lg">OFF</span>
                            </div>
                        </div>
                        <div class="stat bg-base-200 rounded-lg">
                            <div class="stat-title">Mode</div>
                            <div class="stat-value text-2xl">
                                <span id="mode" class="badge badge-lg">AUTO</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contrôles Superviseur (uniquement niveaux 1-3) -->
            <% if (niveau !== '0') { %>

            <!-- Form 1: Mode -->
            <form id="form-mode" class="control-form">
                <h3>Mode de fonctionnement</h3>
                <div class="control-group">
                    <label class="control-label">Sélectionner le mode</label>
                    <select id="mode-select" class="control-select">
                        <option value="auto">AUTO</option>
                        <option value="manuel">MANUEL</option>
                    </select>
                </div>
                <button type="submit" class="submit-btn">Envoyer Mode</button>
            </form>

            <!-- Form 2: Consignes -->
            <form id="form-consignes" class="control-form">
                <h3>Consignes</h3>
                <div class="control-grid control-grid-3">
                    <div class="control-group">
                        <label class="control-label">
                            <span>Consigne Niveau GB</span>
                            <span class="control-value" id="consNivGB-value">50%</span>
                        </label>
                        <input type="range" id="consNivGB" min="0" max="100" value="50" class="control-slider" step="1">
                        <div class="control-markers">
                            <span>0%</span>
                            <span>50%</span>
                            <span>100%</span>
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label">
                            <span>Consigne Niveau PB</span>
                            <span class="control-value" id="consNivPB-value">50%</span>
                        </label>
                        <input type="range" id="consNivPB" min="0" max="100" value="50" class="control-slider" step="1">
                        <div class="control-markers">
                            <span>0%</span>
                            <span>50%</span>
                            <span>100%</span>
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label">
                            <span>Consigne Temp PB</span>
                            <span class="control-value" id="consTmpPB-value">50°C</span>
                        </label>
                        <input type="range" id="consTmpPB" min="0" max="100" value="50" class="control-slider" step="1">
                        <div class="control-markers">
                            <span>0°C</span>
                            <span>50°C</span>
                            <span>100°C</span>
                        </div>
                    </div>
                </div>
                <button type="submit" class="submit-btn">Envoyer Consignes</button>
            </form>

            <!-- Form 3: Valves (%) -->
            <form id="form-valves" class="control-form">
                <h3>Ouverture des Valves</h3>
                <div class="control-grid control-grid-4">
                    <div class="control-group">
                        <label class="control-label">
                            <span>Valve GB</span>
                            <span class="control-value" id="valveGB-cmd-value">50%</span>
                        </label>
                        <input type="range" id="valveGB-cmd" min="0" max="100" value="50" class="control-slider" step="1">
                        <div class="control-markers">
                            <span>0</span>
                            <span>100</span>
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label">
                            <span>Valve PB</span>
                            <span class="control-value" id="valvePB-cmd-value">50%</span>
                        </label>
                        <input type="range" id="valvePB-cmd" min="0" max="100" value="50" class="control-slider" step="1">
                        <div class="control-markers">
                            <span>0</span>
                            <span>100</span>
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label">
                            <span>Valve EC</span>
                            <span class="control-value" id="valveEC-cmd-value">50%</span>
                        </label>
                        <input type="range" id="valveEC-cmd" min="0" max="100" value="50" class="control-slider" step="1">
                        <div class="control-markers">
                            <span>0</span>
                            <span>100</span>
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label">
                            <span>Valve EF</span>
                            <span class="control-value" id="valveEF-cmd-value">50%</span>
                        </label>
                        <input type="range" id="valveEF-cmd" min="0" max="100" value="50" class="control-slider" step="1">
                        <div class="control-markers">
                            <span>0</span>
                            <span>100</span>
                        </div>
                    </div>
                </div>
                <button type="submit" class="submit-btn">Envoyer Valves</button>
            </form>

            <!-- Form 4: Valves ON/OFF et Pompe -->
            <form id="form-onoff" class="control-form">
                <h3>Équipements ON/OFF</h3>
                <div class="control-grid control-grid-3">
                    <div class="control-group">
                        <label class="control-label">Valve EEC</label>
                        <select id="valveEEC-select" class="control-select">
                            <option value="off">OFF</option>
                            <option value="on">ON</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label class="control-label">Valve EEF</label>
                        <select id="valveEEF-select" class="control-select">
                            <option value="off">OFF</option>
                            <option value="on">ON</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label class="control-label">Pompe</label>
                        <select id="pompe-select" class="control-select">
                            <option value="off">OFF</option>
                            <option value="on">ON</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="submit-btn">Envoyer Équipements</button>
            </form>

            <% } %>

            <!-- Accès Raspberry Pi -->
            <div class="card bg-base-100 shadow-2xl mb-6">
                <div class="card-body">
                    <h2 class="card-title text-2xl mb-4">Raspberry Pi disponibles</h2>
                    <div id="raspberry-pi-container">
                        <!-- Généré dynamiquement selon le niveau -->
                    </div>
                </div>
            </div>

            <!-- Bouton déconnexion -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <div class="card-actions justify-end">
                        <a href="/" class="btn btn-outline">
                            Déconnexion
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <%- include('../partials/footer') %>

    <script>
        const socket = io();
        const niveau = '<%= niveau %>';
        const user = '<%= user %>';
        const typeAcces = '<%= typeAcces %>';

        // Gestion de la connexion Socket.IO
        socket.on('connect', () =>
        {
            console.log('Connecté à Socket.IO');
            const el = document.getElementById('connection-status');
            el.className = 'badge badge-success badge-lg';
            el.textContent = 'En ligne';
        });

        socket.on('disconnect', () =>
        {
            console.log('Déconnecté de Socket.IO');
            const el = document.getElementById('connection-status');
            el.className = 'badge badge-error badge-lg';
            el.textContent = 'Hors ligne';
        });

        // Recevoir les données initiales
        socket.on('mqtt-initial-data', (data) =>
        {
            console.log('Données initiales:', data);
            updateAllData(data);
        });

        // Recevoir les mises à jour en temps réel
        socket.on('mqtt-data', (data) =>
        {
            console.log('Mise à jour:', data);
            updateValue(data.key, data.value);
        });

        // Fonction pour mettre à jour une valeur
        function updateValue(key, value)
        {
            const elementId = key.toLowerCase();
            const element = document.getElementById(elementId);

            if (element)
            {
                if (typeof value === 'number')
                {
                    if (key.startsWith('Valve') && !key.includes('EE'))
                    {
                        element.textContent = value + '%';
                    }
                    else if (key === 'TmpPB')
                    {
                        element.textContent = value + '°C';
                    }
                    else if (key.startsWith('Niv'))
                    {
                        element.textContent = value + '%';
                    }
                }
                else
                {
                    // Pour le Mode (auto/manuel)
                    if (key === 'Mode')
                    {
                        const isAuto = value.toLowerCase() === 'auto';
                        element.className = `badge badge-lg ${isAuto ? 'badge-primary' : 'badge-warning'}`;
                        element.textContent = value.toUpperCase();
                    }
                    // Pour les valeurs ON/OFF
                    else
                    {
                        const isOn = value.toLowerCase() === 'on';
                        element.className = `badge badge-lg ${isOn ? 'badge-success' : 'badge-ghost'}`;
                        element.textContent = value.toUpperCase();
                    }
                }
            }
        }

        // Fonction pour mettre à jour toutes les données
        function updateAllData(data)
        {
            Object.keys(data).forEach(key =>
            {
                updateValue(key, data[key]);
            });
        }

        // Générer les liens Raspberry Pi - TOUS les niveaux (0-3) ont accès à TOUS les Pi
        // La différence : Niveau 0 = lecture seule, Niveaux 1-3 = lecture + écriture
        const piNames = ['Balance', 'Mélangeur', 'Power Meter', 'Aspirateur', 'Valves', 'Pi 6'];
        const container = document.getElementById('raspberry-pi-container');

        const grid = document.createElement('div');
        grid.className = 'grid grid-cols-2 md:grid-cols-3 gap-3';

        // Afficher tous les 6 Raspberry Pi pour tous les niveaux
        for (let piNum = 1; piNum <= 6; piNum++)
        {
            const name = piNames[piNum - 1];
            const link = document.createElement('a');
            link.href = `/raspberrypi${piNum}?niveau=${niveau}&user=${encodeURIComponent(user)}&typeAcces=${encodeURIComponent(typeAcces)}`;
            link.className = `btn btn-outline gap-2`;
            link.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
                </svg>
                ${name}
            `;
            grid.appendChild(link);
        }

        container.appendChild(grid);

        // Afficher un message selon le niveau
        if (niveau === '0')
        {
            const notice = document.createElement('div');
            notice.className = 'alert mt-4';
            notice.textContent = 'Mode consultation uniquement - Vous pouvez visualiser les données mais pas envoyer de commandes.';
            container.appendChild(notice);
        }

        // Gestionnaires de commandes (uniquement niveaux 1-3)
        if (niveau !== '0')
        {
            // Mise à jour en temps réel des valeurs des sliders
            document.getElementById('consNivGB').addEventListener('input', (e) =>
            {
                document.getElementById('consNivGB-value').textContent = e.target.value + '%';
            });
            document.getElementById('consNivPB').addEventListener('input', (e) =>
            {
                document.getElementById('consNivPB-value').textContent = e.target.value + '%';
            });
            document.getElementById('consTmpPB').addEventListener('input', (e) =>
            {
                document.getElementById('consTmpPB-value').textContent = e.target.value + '°C';
            });
            document.getElementById('valveGB-cmd').addEventListener('input', (e) =>
            {
                document.getElementById('valveGB-cmd-value').textContent = e.target.value + '%';
            });
            document.getElementById('valvePB-cmd').addEventListener('input', (e) =>
            {
                document.getElementById('valvePB-cmd-value').textContent = e.target.value + '%';
            });
            document.getElementById('valveEC-cmd').addEventListener('input', (e) =>
            {
                document.getElementById('valveEC-cmd-value').textContent = e.target.value + '%';
            });
            document.getElementById('valveEF-cmd').addEventListener('input', (e) =>
            {
                document.getElementById('valveEF-cmd-value').textContent = e.target.value + '%';
            });

            // Form 1: Mode
            document.getElementById('form-mode').addEventListener('submit', (e) =>
            {
                e.preventDefault();
                const mode = document.getElementById('mode-select').value;
                console.log('Envoi Mode:', mode);

                socket.emit('mqtt-command-superviseur',
                {
                    topic: 'RAM/panneau/cmd/Mode',
                    value: mode
                });

                alert('Mode envoyé avec succès !');
            });

            // Form 2: Consignes
            document.getElementById('form-consignes').addEventListener('submit', (e) =>
            {
                e.preventDefault();
                const consNivGB = document.getElementById('consNivGB').value;
                const consNivPB = document.getElementById('consNivPB').value;
                const consTmpPB = document.getElementById('consTmpPB').value;

                console.log('Envoi Consignes:',
                {
                    consNivGB,
                    consNivPB,
                    consTmpPB
                });

                socket.emit('mqtt-command-superviseur',
                {
                    topic: 'RAM/panneau/cmd/ConsNivGB',
                    value: consNivGB
                });
                socket.emit('mqtt-command-superviseur',
                {
                    topic: 'RAM/panneau/cmd/ConsNivPB',
                    value: consNivPB
                });
                socket.emit('mqtt-command-superviseur',
                {
                    topic: 'RAM/panneau/cmd/ConsTmpPB',
                    value: consTmpPB
                });

                alert('Consignes envoyées avec succès !');
            });

            // Form 3: Valves
            document.getElementById('form-valves').addEventListener('submit', (e) =>
            {
                e.preventDefault();
                const valveGB = document.getElementById('valveGB-cmd').value;
                const valvePB = document.getElementById('valvePB-cmd').value;
                const valveEC = document.getElementById('valveEC-cmd').value;
                const valveEF = document.getElementById('valveEF-cmd').value;

                console.log('Envoi Valves:',
                {
                    valveGB,
                    valvePB,
                    valveEC,
                    valveEF
                });

                socket.emit('mqtt-command-superviseur',
                {
                    topic: 'RAM/panneau/cmd/ValveGB',
                    value: valveGB
                });
                socket.emit('mqtt-command-superviseur',
                {
                    topic: 'RAM/panneau/cmd/ValvePB',
                    value: valvePB
                });
                socket.emit('mqtt-command-superviseur',
                {
                    topic: 'RAM/panneau/cmd/ValveEC',
                    value: valveEC
                });
                socket.emit('mqtt-command-superviseur',
                {
                    topic: 'RAM/panneau/cmd/ValveEF',
                    value: valveEF
                });

                alert('Valves envoyées avec succès !');
            });

            // Form 4: Équipements ON/OFF
            document.getElementById('form-onoff').addEventListener('submit', (e) =>
            {
                e.preventDefault();
                const valveEEC = document.getElementById('valveEEC-select').value;
                const valveEEF = document.getElementById('valveEEF-select').value;
                const pompe = document.getElementById('pompe-select').value;

                console.log('Envoi Équipements:',
                {
                    valveEEC,
                    valveEEF,
                    pompe
                });

                socket.emit('mqtt-command-superviseur',
                {
                    topic: 'RAM/panneau/cmd/ValveEEC',
                    value: valveEEC
                });
                socket.emit('mqtt-command-superviseur',
                {
                    topic: 'RAM/panneau/cmd/ValveEEF',
                    value: valveEEF
                });
                socket.emit('mqtt-command-superviseur',
                {
                    topic: 'RAM/panneau/cmd/Pompe',
                    value: pompe
                });

                alert('Équipements envoyés avec succès !');
            });
        }

    </script>
</body>
</html>
